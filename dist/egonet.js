function _applyDecoratedDescriptor(e,t,n,r,o){var i={};return Object.keys(r).forEach(function(s){i[s]=r[s]}),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=n.slice().reverse().reduce(function(s,a){return a(e,t,s)||s},i),o&&i.initializer!==void 0&&(i.value=i.initializer?i.initializer.call(o):void 0,i.initializer=void 0),i.initializer===void 0&&(Object.defineProperty(e,t,i),i=null),i}var _class,_dec;function deferred(){let e;const t=new Promise((n,r)=>{e={resolve:n,reject:r}});return Object.assign(t,e)}class MuxAsyncIterator{iteratorCount=0;yields=[];throws=[];signal=deferred();add(e){++this.iteratorCount,this.callIteratorNext(e)}async callIteratorNext(e){try{const{value:t,done:n}=await e.next();n?--this.iteratorCount:this.yields.push({iterator:e,value:t})}catch(t){this.throws.push(t)}this.signal.resolve()}async*iterate(){for(;this.iteratorCount>0;){await this.signal;for(let e=0;e<this.yields.length;e++){const{iterator:t,value:n}=this.yields[e];yield n,this.callIteratorNext(t)}if(this.throws.length){for(const e of this.throws)throw e;this.throws.length=0}this.yields.length=0,this.signal=deferred()}}[Symbol.asyncIterator](){return this.iterate()}}function _parseAddrFromStr(e){let t;try{const n=e.startsWith(":")?`0.0.0.0${e}`:e;t=new URL(`http://${n}`)}catch{throw new TypeError("Invalid address.")}if(t.username||t.password||t.pathname!="/"||t.search||t.hash)throw new TypeError("Invalid address.");return{hostname:t.hostname,port:t.port===""?80:Number(t.port)}}const CR="\r".charCodeAt(0),LF=`
`.charCodeAt(0);class BufferFullError extends Error{name="BufferFullError";constructor(e){super("Buffer full");this.partial=e}}class AbstractBufBase{usedBufferBytes=0;err=null;size(){return this.buf.byteLength}available(){return this.buf.byteLength-this.usedBufferBytes}buffered(){return this.usedBufferBytes}}function createLPS(e){const t=new Uint8Array(e.length);t[0]=0;let n=0,r=1;for(;r<t.length;)e[r]==e[n]?(n++,t[r]=n,r++):n===0?(t[r]=0,r++):n=e[n-1];return t}async function*readDelim(e,t){const n=t.length,r=createLPS(t);let o=new Deno.Buffer;const i=new Uint8Array(Math.max(1024,n+1));let s=0,a=0;for(;;){const c=await e.read(i);if(c===null){yield o.bytes();return}if(c<0)return;const h=i.subarray(0,c);await Deno.writeAll(o,h);let f=o.bytes();for(;s<f.length;)if(f[s]===t[a]){if(s++,a++,a===n){const p=s-n,w=f.subarray(0,p),g=f.slice(s);yield w,f=g,s=0,a=0}}else a===0?s++:a=r[a-1];o=new Deno.Buffer(f)}}async function*readStringDelim(e,t){const n=new TextEncoder,r=new TextDecoder;for await(const o of readDelim(e,n.encode(t)))yield r.decode(o)}function assert(e,t=""){if(!e)throw new DenoStdInternalError(t)}function findIndex(e,t){const n=t[0];for(let r=0;r<e.length;r++){if(e[r]!==n)continue;const o=r;let i=1,s=r;for(;i<t.length&&!(s++,e[s]!==t[s-r]);)i++;if(i===t.length)return r}return-1}function concat(e,t){const n=new Uint8Array(e.length+t.length);return n.set(e,0),n.set(t,e.length),n}function copyBytes(e,t,n=0){n=Math.max(0,Math.min(n,t.byteLength));const r=t.byteLength-n;return e.byteLength>r&&(e=e.subarray(0,r)),t.set(e,n),e.byteLength}const invalidHeaderCharRegex=/[^\t\x20-\x7e\x80-\xff]/g;function charCode(e){return e.charCodeAt(0)}const encoder=new TextEncoder;function encode(e){return encoder.encode(e)}const decoder=new TextDecoder;function decode(e){return decoder.decode(e)}function emptyReader(){return{read(e){return Promise.resolve(null)}}}function bodyReader(e,t){let n=0,r=!1;async function o(i){if(r)return null;let s;const a=e-n;if(a>=i.byteLength)s=await t.read(i);else{const c=i.subarray(0,a);s=await t.read(c)}return s!==null&&(n+=s),r=n===e,s}return{read:o}}function isProhibidedForTrailer(e){const t=new Set(["transfer-encoding","content-length","trailer"]);return t.has(e.toLowerCase())}function parseTrailer(e){if(e==null)return;const t=e.split(",").map(r=>r.trim().toLowerCase());if(t.length===0)throw new Deno.errors.InvalidData("Empty trailer header.");const n=t.filter(r=>isProhibidedForTrailer(r));if(n.length>0)throw new Deno.errors.InvalidData(`Prohibited trailer names: ${Deno.inspect(n)}.`);return new Headers(t.map(r=>[r,""]))}async function writeChunkedBody(e,t){for await(const r of Deno.iter(t)){if(r.byteLength<=0)continue;const o=encoder.encode(`${r.byteLength.toString(16)}\r
`),i=encoder.encode(`\r
`);await e.write(o),await e.write(r),await e.write(i),await e.flush()}const n=encoder.encode(`0\r
\r
`);await e.write(n)}function parseHTTPVersion(e){switch(e){case"HTTP/1.1":return[1,1];case"HTTP/1.0":return[1,0];default:{const t=1e6;if(!e.startsWith("HTTP/"))break;const n=e.indexOf(".");if(n<0)break;const r=e.substring(e.indexOf("/")+1,n),o=Number(r);if(!Number.isInteger(o)||o<0||o>1e6)break;const i=e.substring(n+1),s=Number(i);if(!Number.isInteger(s)||s<0||s>1e6)break;return[o,s]}}throw new Error(`malformed HTTP version ${e}`)}function fixLength(e){const t=e.headers.get("Content-Length");if(t){const n=t.split(",");if(n.length>1){const o=[...new Set(n.map(i=>i.trim()))];if(o.length>1)throw Error("cannot contain multiple Content-Length headers");e.headers.set("Content-Length",o[0])}const r=e.headers.get("Content-Length");if(e.method==="HEAD"&&r&&r!=="0")throw Error("http: method cannot contain a Content-Length");if(r&&e.headers.has("transfer-encoding"))throw new Error("http: Transfer-Encoding and Content-Length cannot be send together")}}class BufReader{r=0;w=0;eof=!1;static create(e,t=4096){return e instanceof BufReader?e:new BufReader(e,t)}constructor(e,t=4096){t<16&&(t=16),this._reset(new Uint8Array(t),e)}size(){return this.buf.byteLength}buffered(){return this.w-this.r}async _fill(){if(this.r>0&&(this.buf.copyWithin(0,this.r,this.w),this.w-=this.r,this.r=0),this.w>=this.buf.byteLength)throw Error("bufio: tried to fill full buffer");for(let e=100;e>0;e--){const t=await this.rd.read(this.buf.subarray(this.w));if(t===null){this.eof=!0;return}if(assert(t>=0,"negative read"),this.w+=t,t>0)return}throw new Error(`No progress after ${100} read() calls`)}reset(e){this._reset(this.buf,e)}_reset(e,t){this.buf=e,this.rd=t,this.eof=!1}async read(e){let t=e.byteLength;if(e.byteLength===0)return t;if(this.r===this.w){if(e.byteLength>=this.buf.byteLength){const r=await this.rd.read(e),o=r??0;return assert(o>=0,"negative read"),r}if(this.r=0,this.w=0,t=await this.rd.read(this.buf),t===0||t===null)return t;assert(t>=0,"negative read"),this.w+=t}const n=copyBytes(this.buf.subarray(this.r,this.w),e,0);return this.r+=n,n}async readFull(e){let t=0;for(;t<e.length;)try{const n=await this.read(e.subarray(t));if(n===null){if(t===0)return null;throw new PartialReadError}t+=n}catch(n){throw n.partial=e.subarray(0,t),n}return e}async readByte(){for(;this.r===this.w;){if(this.eof)return null;await this._fill()}const e=this.buf[this.r];return this.r++,e}async readString(e){if(e.length!==1)throw new Error("Delimiter should be a single character");const t=await this.readSlice(e.charCodeAt(0));return t===null?null:new TextDecoder().decode(t)}async readLine(){let e;try{e=await this.readSlice(LF)}catch(t){let{partial:n}=t;if(assert(n instanceof Uint8Array,"bufio: caught error from `readSlice()` without `partial` property"),!(t instanceof BufferFullError))throw t;return!this.eof&&n.byteLength>0&&n[n.byteLength-1]===CR&&(assert(this.r>0,"bufio: tried to rewind past start of buffer"),this.r--,n=n.subarray(0,n.byteLength-1)),{line:n,more:!this.eof}}if(e===null)return null;if(e.byteLength===0)return{line:e,more:!1};if(e[e.byteLength-1]==LF){let t=1;e.byteLength>1&&e[e.byteLength-2]===CR&&(t=2),e=e.subarray(0,e.byteLength-t)}return{line:e,more:!1}}async readSlice(e){let t=0,n;for(;;){let r=this.buf.subarray(this.r+t,this.w).indexOf(e);if(r>=0){r+=t,n=this.buf.subarray(this.r,this.r+r+1),this.r+=r+1;break}if(this.eof){if(this.r===this.w)return null;n=this.buf.subarray(this.r,this.w),this.r=this.w;break}if(this.buffered()>=this.buf.byteLength){this.r=this.w;const o=this.buf,i=this.buf.slice(0);throw this.buf=i,new BufferFullError(o)}t=this.w-this.r;try{await this._fill()}catch(o){throw o.partial=n,o}}return n}async peek(e){if(e<0)throw Error("negative count");let t=this.w-this.r;for(;t<e&&t<this.buf.byteLength&&!this.eof;){try{await this._fill()}catch(n){throw n.partial=this.buf.subarray(this.r,this.w),n}t=this.w-this.r}if(t===0&&this.eof)return null;if(t<e&&this.eof)return this.buf.subarray(this.r,this.r+t);if(t<e)throw new BufferFullError(this.buf.subarray(this.r,this.w));return this.buf.subarray(this.r,this.r+e)}}class BufWriter extends AbstractBufBase{static create(e,t=4096){return e instanceof BufWriter?e:new BufWriter(e,t)}constructor(e,t=4096){super();this.writer=e,t<=0&&(t=4096),this.buf=new Uint8Array(t)}reset(e){this.err=null,this.usedBufferBytes=0,this.writer=e}async flush(){if(this.err!==null)throw this.err;if(this.usedBufferBytes===0)return;try{await Deno.writeAll(this.writer,this.buf.subarray(0,this.usedBufferBytes))}catch(e){throw this.err=e,e}this.buf=new Uint8Array(this.buf.length),this.usedBufferBytes=0}async write(e){if(this.err!==null)throw this.err;if(e.length===0)return 0;let t=0,n=0;for(;e.byteLength>this.available();){if(this.buffered()===0)try{n=await this.writer.write(e)}catch(r){throw this.err=r,r}else n=copyBytes(e,this.buf,this.usedBufferBytes),this.usedBufferBytes+=n,await this.flush();t+=n,e=e.subarray(n)}return n=copyBytes(e,this.buf,this.usedBufferBytes),this.usedBufferBytes+=n,t+=n,t}}class BufWriterSync extends AbstractBufBase{static create(e,t=4096){return e instanceof BufWriterSync?e:new BufWriterSync(e,t)}constructor(e,t=4096){super();this.writer=e,t<=0&&(t=4096),this.buf=new Uint8Array(t)}reset(e){this.err=null,this.usedBufferBytes=0,this.writer=e}flush(){if(this.err!==null)throw this.err;if(this.usedBufferBytes===0)return;try{Deno.writeAllSync(this.writer,this.buf.subarray(0,this.usedBufferBytes))}catch(e){throw this.err=e,e}this.buf=new Uint8Array(this.buf.length),this.usedBufferBytes=0}writeSync(e){if(this.err!==null)throw this.err;if(e.length===0)return 0;let t=0,n=0;for(;e.byteLength>this.available();){if(this.buffered()===0)try{n=this.writer.writeSync(e)}catch(r){throw this.err=r,r}else n=copyBytes(e,this.buf,this.usedBufferBytes),this.usedBufferBytes+=n,this.flush();t+=n,e=e.subarray(n)}return n=copyBytes(e,this.buf,this.usedBufferBytes),this.usedBufferBytes+=n,t+=n,t}}function str(e){return e==null?"":decode(e)}class TextProtoReader{constructor(e){this.r=e}async readLine(){const e=await this.readLineSlice();return e===null?null:str(e)}async readMIMEHeader(){const e=new Headers;let t,n=await this.r.peek(1);if(n===null)return null;if((n[0]==charCode(" ")||n[0]==charCode("	"))&&(t=await this.readLineSlice()),n=await this.r.peek(1),n===null)throw new Deno.errors.UnexpectedEof;if(n[0]==charCode(" ")||n[0]==charCode("	"))throw new Deno.errors.InvalidData(`malformed MIME header initial line: ${str(t)}`);for(;;){const r=await this.readLineSlice();if(r===null)throw new Deno.errors.UnexpectedEof;if(r.byteLength===0)return e;let o=r.indexOf(charCode(":"));if(o<0)throw new Deno.errors.InvalidData(`malformed MIME header line: ${str(r)}`);const i=str(r.subarray(0,o));if(i=="")continue;for(o++;o<r.byteLength&&(r[o]==charCode(" ")||r[o]==charCode("	"));)o++;const s=str(r.subarray(o)).replace(invalidHeaderCharRegex,encodeURI);try{e.append(i,s)}catch{}}}async readLineSlice(){let e;for(;;){const t=await this.r.readLine();if(t===null)return null;const{line:n,more:r}=t;if(!e&&!r)return this.skipSpace(n)===0?new Uint8Array(0):n;if(e=e?concat(e,n):n,!r)break}return e}skipSpace(e){let t=0;for(let n=0;n<e.length;n++){if(e[n]===charCode(" ")||e[n]===charCode("	"))continue;t++}return t}}async function readTrailers(e,t){const n=parseTrailer(e.get("trailer"));if(n==null)return;const r=[...n.keys()],o=new TextProtoReader(t),i=await o.readMIMEHeader();if(i==null)throw new Deno.errors.InvalidData("Missing trailer header.");const s=[...i.keys()].filter(c=>!r.includes(c));if(s.length>0)throw new Deno.errors.InvalidData(`Undeclared trailers: ${Deno.inspect(s)}.`);for(const[c,h]of i)e.append(c,h);const a=r.filter(c=>!i.has(c));if(a.length>0)throw new Deno.errors.InvalidData(`Missing trailers: ${Deno.inspect(a)}.`);e.delete("trailer")}async function writeTrailers(e,t,n){const r=t.get("trailer");if(r===null)throw new TypeError("Missing trailer header.");const o=t.get("transfer-encoding");if(o===null||!o.match(/^chunked/))throw new TypeError(`Trailers are only allowed for "transfer-encoding: chunked", got "transfer-encoding: ${o}".`);const i=BufWriter.create(e),s=r.split(",").map(h=>h.trim().toLowerCase()),a=s.filter(h=>isProhibidedForTrailer(h));if(a.length>0)throw new TypeError(`Prohibited trailer names: ${Deno.inspect(a)}.`);const c=[...n.keys()].filter(h=>!s.includes(h));if(c.length>0)throw new TypeError(`Undeclared trailers: ${Deno.inspect(c)}.`);for(const[h,f]of n)await i.write(encoder.encode(`${h}: ${f}\r
`));await i.write(encoder.encode(`\r
`)),await i.flush()}function chunkedBodyReader(e,t){const n=new TextProtoReader(t);let r=!1;const o=[];async function i(s){if(r)return null;const[a]=o;if(a){const p=a.data.byteLength-a.offset,w=Math.min(p,s.byteLength);for(let g=0;g<w;g++)s[g]=a.data[a.offset+g];if(a.offset+=w,a.offset===a.data.byteLength&&(o.shift(),await n.readLine()===null))throw new Deno.errors.UnexpectedEof;return w}const c=await n.readLine();if(c===null)throw new Deno.errors.UnexpectedEof;const[h]=c.split(";"),f=parseInt(h,16);if(Number.isNaN(f)||f<0)throw new Deno.errors.InvalidData("Invalid chunk size");if(f>0)if(f>s.byteLength){let p=await t.readFull(s);if(p===null)throw new Deno.errors.UnexpectedEof;const w=new Uint8Array(f-s.byteLength);if(p=await t.readFull(w),p===null)throw new Deno.errors.UnexpectedEof;return o.push({offset:0,data:w}),s.byteLength}else{const p=s.subarray(0,f),w=await t.readFull(p);if(w===null)throw new Deno.errors.UnexpectedEof;if(await n.readLine()===null)throw new Deno.errors.UnexpectedEof;return f}else{if(assert(f===0),await t.readLine()===null)throw new Deno.errors.UnexpectedEof;return await readTrailers(e,t),r=!0,null}}return{read:i}}const noColor=globalThis.Deno?.noColor??!0;let enabled=!noColor;function code(e,t){return{open:`[${e.join(";")}m`,close:`[${t}m`,regexp:new RegExp(`\\x1b\\[${t}m`,"g")}}function run(e,t){return enabled?`${t.open}${e.replace(t.regexp,t.open)}${t.close}`:e}function bold(e){return run(e,code([1],22))}function underline(e){return run(e,code([4],24))}function brightBlack(e){return run(e,code([90],39))}function brightRed(e){return run(e,code([91],39))}function brightGreen(e){return run(e,code([92],39))}function brightYellow(e){return run(e,code([93],39))}function brightCyan(e){return run(e,code([96],39))}function clampAndTruncate(e,t=255,n=0){return Math.trunc(Math.max(Math.min(e,t),n))}const ANSI_PATTERN=new RegExp(["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:[a-zA-Z\\d]*(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-ntqry=><~]))"].join("|"),"g");function stripColor(e){return e.replace(ANSI_PATTERN,"")}function _applyDecoratedDescriptor1(e,t,n,r,o){var i={};return Object.keys(r).forEach(function(s){i[s]=r[s]}),i.enumerable=!!i.enumerable,i.configurable=!!i.configurable,("value"in i||i.initializer)&&(i.writable=!0),i=n.slice().reverse().reduce(function(s,a){return a(e,t,s)||s},i),o&&i.initializer!==void 0&&(i.value=i.initializer?i.initializer.call(o):void 0,i.initializer=void 0),i.initializer===void 0&&(Object.defineProperty(e,t,i),i=null),i}var _class1,_dec1,_dec2,_dec3,_dec4,exports={},_dewExec=!1,_global=typeof globalThis!="undefined"?globalThis:typeof self!="undefined"?self:global,exports1={},_dewExec1=!1;function dew(){if(_dewExec1)return exports1;_dewExec1=!0,exports1=function(r){t(r);var o=e(r);return r.on=o.on,r.off=o.off,r.fire=o.fire,r};function e(n){var r=Object.create(null);return{on:function(o,i,s){if(typeof i!="function")throw new Error("callback is expected to be a function");var a=r[o];return a||(a=r[o]=[]),a.push({callback:i,ctx:s}),n},off:function(o,i){var s=typeof o=="undefined";if(s)return r=Object.create(null),n;if(r[o]){var a=typeof i!="function";if(a)delete r[o];else for(var c=r[o],h=0;h<c.length;++h)c[h].callback===i&&c.splice(h,1)}return n},fire:function(o){var i=r[o];if(!i)return n;var s;arguments.length>1&&(s=Array.prototype.splice.call(arguments,1));for(var a=0;a<i.length;++a){var c=i[a];c.callback.apply(c.ctx,s)}return n}}}function t(n){if(!n)throw new Error("Eventify cannot use falsy object as events subject");for(var r=["on","fire","off"],o=0;o<r.length;++o)if(n.hasOwnProperty(r[o]))throw new Error("Subject cannot be eventified, since it already has property '"+r[o]+"'")}return exports1}async function timeoutAsync(e,t,n){let r;return Promise.race([new Promise((o,i)=>{r=setTimeout(()=>{clearTimeout(r),i(new Error("timeout"))},n)}),e.apply(this,t)]).then(o=>(clearTimeout(r),o))}const sleep=e=>new Promise(t=>setTimeout(t,e));class LruCache{values=new Map;maxEntries=500;get(e){const t=this.values.get(e);return t!==void 0&&(this.values.delete(e),this.values.set(e,t)),t}has(e){return this.values.has(e)}put(e,t){if(this.values.size>=this.maxEntries){const n=this.values.keys().next().value;this.values.delete(n)}this.values.set(e,t)}}var BackOffPolicy;(function(e){e.FixedBackOffPolicy="FixedBackOffPolicy",e.ExponentialBackOffPolicy="ExponentialBackOffPolicy"})(BackOffPolicy||(BackOffPolicy={}));const fetchHeader={headers:{}},httpProxy=Deno.env.get("HTTP_PROXY");if(httpProxy){const e=new URL(httpProxy);fetchHeader.headers={Authorization:`Basic ${btoa(e.username+":"+e.password)}`},console.info(`Using HTTP_PROXY (origin="${e.origin}", Authorization="Basic ***...***")`)}async function timeoutAsync1(e,t,n){let r;return Promise.race([new Promise((o,i)=>{r=setTimeout(()=>{clearTimeout(r),i(new Error("timeout"))},n)}),e.apply(this,t)]).then(o=>(clearTimeout(r),o))}const sleep1=e=>new Promise(t=>setTimeout(t,e));class LruCache1{values=new Map;maxEntries=500;get(e){const t=this.values.get(e);return t!==void 0&&(this.values.delete(e),this.values.set(e,t)),t}has(e){return this.values.has(e)}put(e,t){if(this.values.size>=this.maxEntries){const n=this.values.keys().next().value;this.values.delete(n)}this.values.set(e,t)}}var BackOffPolicy1;(function(e){e.FixedBackOffPolicy="FixedBackOffPolicy",e.ExponentialBackOffPolicy="ExponentialBackOffPolicy"})(BackOffPolicy1||(BackOffPolicy1={}));function Memoize(e={}){return function(t,n,r){const o=r.value,i=new LruCache1;let s=Number.POSITIVE_INFINITY;return r.value=async function(...a){const c=e.resolver?e.resolver.apply(this,a):JSON.stringify(a);if(i.has(c)&&(!e.ttl||s>Date.now())){const h=i.get(c);return e.onFound?.apply(this,[c,h]),h}else{const h=await o.apply(this,a);return i.put(c,h),e.onAdded?.apply(this,[c,h]),e.ttl&&(s=Date.now()+e.ttl),h}},r}}const SERVER_HOST="0.0.0.0",SERVER_PORT=Deno.env.get("PORT")??"8080",REDIS_URL=Deno.env.get("FLY_REDIS_CACHE_URL"),ALLOWED_ORIGINS=["https://ego.jveres.me"],CACHE_EXPIRATION_MS=12*60*60*1e3;var Status;(function(e){e[e.Continue=100]="Continue",e[e.SwitchingProtocols=101]="SwitchingProtocols",e[e.Processing=102]="Processing",e[e.EarlyHints=103]="EarlyHints",e[e.OK=200]="OK",e[e.Created=201]="Created",e[e.Accepted=202]="Accepted",e[e.NonAuthoritativeInfo=203]="NonAuthoritativeInfo",e[e.NoContent=204]="NoContent",e[e.ResetContent=205]="ResetContent",e[e.PartialContent=206]="PartialContent",e[e.MultiStatus=207]="MultiStatus",e[e.AlreadyReported=208]="AlreadyReported",e[e.IMUsed=226]="IMUsed",e[e.MultipleChoices=300]="MultipleChoices",e[e.MovedPermanently=301]="MovedPermanently",e[e.Found=302]="Found",e[e.SeeOther=303]="SeeOther",e[e.NotModified=304]="NotModified",e[e.UseProxy=305]="UseProxy",e[e.TemporaryRedirect=307]="TemporaryRedirect",e[e.PermanentRedirect=308]="PermanentRedirect",e[e.BadRequest=400]="BadRequest",e[e.Unauthorized=401]="Unauthorized",e[e.PaymentRequired=402]="PaymentRequired",e[e.Forbidden=403]="Forbidden",e[e.NotFound=404]="NotFound",e[e.MethodNotAllowed=405]="MethodNotAllowed",e[e.NotAcceptable=406]="NotAcceptable",e[e.ProxyAuthRequired=407]="ProxyAuthRequired",e[e.RequestTimeout=408]="RequestTimeout",e[e.Conflict=409]="Conflict",e[e.Gone=410]="Gone",e[e.LengthRequired=411]="LengthRequired",e[e.PreconditionFailed=412]="PreconditionFailed",e[e.RequestEntityTooLarge=413]="RequestEntityTooLarge",e[e.RequestURITooLong=414]="RequestURITooLong",e[e.UnsupportedMediaType=415]="UnsupportedMediaType",e[e.RequestedRangeNotSatisfiable=416]="RequestedRangeNotSatisfiable",e[e.ExpectationFailed=417]="ExpectationFailed",e[e.Teapot=418]="Teapot",e[e.MisdirectedRequest=421]="MisdirectedRequest",e[e.UnprocessableEntity=422]="UnprocessableEntity",e[e.Locked=423]="Locked",e[e.FailedDependency=424]="FailedDependency",e[e.TooEarly=425]="TooEarly",e[e.UpgradeRequired=426]="UpgradeRequired",e[e.PreconditionRequired=428]="PreconditionRequired",e[e.TooManyRequests=429]="TooManyRequests",e[e.RequestHeaderFieldsTooLarge=431]="RequestHeaderFieldsTooLarge",e[e.UnavailableForLegalReasons=451]="UnavailableForLegalReasons",e[e.InternalServerError=500]="InternalServerError",e[e.NotImplemented=501]="NotImplemented",e[e.BadGateway=502]="BadGateway",e[e.ServiceUnavailable=503]="ServiceUnavailable",e[e.GatewayTimeout=504]="GatewayTimeout",e[e.HTTPVersionNotSupported=505]="HTTPVersionNotSupported",e[e.VariantAlsoNegotiates=506]="VariantAlsoNegotiates",e[e.InsufficientStorage=507]="InsufficientStorage",e[e.LoopDetected=508]="LoopDetected",e[e.NotExtended=510]="NotExtended",e[e.NetworkAuthenticationRequired=511]="NetworkAuthenticationRequired"})(Status||(Status={}));const STATUS_TEXT=new Map([[Status.Continue,"Continue"],[Status.SwitchingProtocols,"Switching Protocols"],[Status.Processing,"Processing"],[Status.EarlyHints,"Early Hints"],[Status.OK,"OK"],[Status.Created,"Created"],[Status.Accepted,"Accepted"],[Status.NonAuthoritativeInfo,"Non-Authoritative Information"],[Status.NoContent,"No Content"],[Status.ResetContent,"Reset Content"],[Status.PartialContent,"Partial Content"],[Status.MultiStatus,"Multi-Status"],[Status.AlreadyReported,"Already Reported"],[Status.IMUsed,"IM Used"],[Status.MultipleChoices,"Multiple Choices"],[Status.MovedPermanently,"Moved Permanently"],[Status.Found,"Found"],[Status.SeeOther,"See Other"],[Status.NotModified,"Not Modified"],[Status.UseProxy,"Use Proxy"],[Status.TemporaryRedirect,"Temporary Redirect"],[Status.PermanentRedirect,"Permanent Redirect"],[Status.BadRequest,"Bad Request"],[Status.Unauthorized,"Unauthorized"],[Status.PaymentRequired,"Payment Required"],[Status.Forbidden,"Forbidden"],[Status.NotFound,"Not Found"],[Status.MethodNotAllowed,"Method Not Allowed"],[Status.NotAcceptable,"Not Acceptable"],[Status.ProxyAuthRequired,"Proxy Authentication Required"],[Status.RequestTimeout,"Request Timeout"],[Status.Conflict,"Conflict"],[Status.Gone,"Gone"],[Status.LengthRequired,"Length Required"],[Status.PreconditionFailed,"Precondition Failed"],[Status.RequestEntityTooLarge,"Request Entity Too Large"],[Status.RequestURITooLong,"Request URI Too Long"],[Status.UnsupportedMediaType,"Unsupported Media Type"],[Status.RequestedRangeNotSatisfiable,"Requested Range Not Satisfiable"],[Status.ExpectationFailed,"Expectation Failed"],[Status.Teapot,"I'm a teapot"],[Status.MisdirectedRequest,"Misdirected Request"],[Status.UnprocessableEntity,"Unprocessable Entity"],[Status.Locked,"Locked"],[Status.FailedDependency,"Failed Dependency"],[Status.TooEarly,"Too Early"],[Status.UpgradeRequired,"Upgrade Required"],[Status.PreconditionRequired,"Precondition Required"],[Status.TooManyRequests,"Too Many Requests"],[Status.RequestHeaderFieldsTooLarge,"Request Header Fields Too Large"],[Status.UnavailableForLegalReasons,"Unavailable For Legal Reasons"],[Status.InternalServerError,"Internal Server Error"],[Status.NotImplemented,"Not Implemented"],[Status.BadGateway,"Bad Gateway"],[Status.ServiceUnavailable,"Service Unavailable"],[Status.GatewayTimeout,"Gateway Timeout"],[Status.HTTPVersionNotSupported,"HTTP Version Not Supported"],[Status.VariantAlsoNegotiates,"Variant Also Negotiates"],[Status.InsufficientStorage,"Insufficient Storage"],[Status.LoopDetected,"Loop Detected"],[Status.NotExtended,"Not Extended"],[Status.NetworkAuthenticationRequired,"Network Authentication Required"]]),noColor1=globalThis.Deno?.noColor??!0;let enabled1=!noColor1;function code1(e,t){return{open:`[${e.join(";")}m`,close:`[${t}m`,regexp:new RegExp(`\\x1b\\[${t}m`,"g")}}function run1(e,t){return enabled1?`${t.open}${e.replace(t.regexp,t.open)}${t.close}`:e}function bold1(e){return run1(e,code1([1],22))}function green(e){return run1(e,code1([32],39))}function brightBlack1(e){return run1(e,code1([90],39))}function brightRed1(e){return run1(e,code1([91],39))}function brightYellow1(e){return run1(e,code1([93],39))}function brightMagenta(e){return run1(e,code1([95],39))}function brightCyan1(e){return run1(e,code1([96],39))}function clampAndTruncate1(e,t=255,n=0){return Math.trunc(Math.max(Math.min(e,t),n))}const ANSI_PATTERN1=new RegExp(["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:[a-zA-Z\\d]*(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-ntqry=><~]))"].join("|"),"g");async function writeResponse(e,t){const n=1,r=1,o=t.status||200,i=STATUS_TEXT.get(o),s=BufWriter.create(e);if(!i)throw new Deno.errors.InvalidData("Bad status code");t.body||(t.body=new Uint8Array),typeof t.body=="string"&&(t.body=encoder.encode(t.body));let a=`HTTP/${1}.${1} ${o} ${i}\r
`;const c=t.headers??new Headers;t.body&&!c.get("content-length")&&(t.body instanceof Uint8Array?a+=`content-length: ${t.body.byteLength}\r
`:c.get("transfer-encoding")||(a+=`transfer-encoding: chunked\r
`));for(const[p,w]of c)a+=`${p}: ${w}\r
`;a+=`\r
`;const h=encoder.encode(a),f=await s.write(h);if(assert(f===h.byteLength),t.body instanceof Uint8Array){const p=await s.write(t.body);assert(p===t.body.byteLength)}else if(c.has("content-length")){const p=c.get("content-length");assert(p!=null);const w=parseInt(p),g=await Deno.copy(t.body,s);assert(g===w)}else await writeChunkedBody(s,t.body);if(t.trailers){const p=await t.trailers();await writeTrailers(s,c,p)}await s.flush()}class ServerRequest{done=deferred();_contentLength=void 0;get contentLength(){if(this._contentLength===void 0){const e=this.headers.get("content-length");e?(this._contentLength=parseInt(e),Number.isNaN(this._contentLength)&&(this._contentLength=null)):this._contentLength=null}return this._contentLength}_body=null;get body(){if(!this._body)if(this.contentLength!=null)this._body=bodyReader(this.contentLength,this.r);else{const e=this.headers.get("transfer-encoding");if(e!=null){const t=e.split(",").map(n=>n.trim().toLowerCase());assert(t.includes("chunked"),'transfer-encoding must include "chunked" if content-length is not set'),this._body=chunkedBodyReader(this.headers,this.r)}else this._body=emptyReader()}return this._body}async respond(e){let t;try{await writeResponse(this.w,e)}catch(n){try{this.conn.close()}catch{}t=n}if(this.done.resolve(t),t)throw t}finalized=!1;async finalize(){if(this.finalized)return;const e=this.body,t=new Uint8Array(1024);for(;await e.read(t)!==null;);this.finalized=!0}}async function readRequest(e,t){const n=new TextProtoReader(t),r=await n.readLine();if(r===null)return null;const o=await n.readMIMEHeader();if(o===null)throw new Deno.errors.UnexpectedEof;const i=new ServerRequest;return i.conn=e,i.r=t,[i.method,i.url,i.proto]=r.split(" ",3),[i.protoMinor,i.protoMajor]=parseHTTPVersion(i.proto),i.headers=o,fixLength(i),i}class Server{closing=!1;connections=[];constructor(e){this.listener=e}close(){this.closing=!0,this.listener.close();for(const e of this.connections)try{e.close()}catch(t){if(!(t instanceof Deno.errors.BadResource))throw t}}async*iterateHttpRequests(e){const t=new BufReader(e),n=new BufWriter(e);for(;!this.closing;){let r;try{r=await readRequest(e,t)}catch(i){if(i instanceof Deno.errors.InvalidData||i instanceof Deno.errors.UnexpectedEof)try{await writeResponse(n,{status:400,body:encode(`${i.message}\r
\r
`)})}catch(s){}break}if(r===null)break;r.w=n,yield r;const o=await r.done;if(o){this.untrackConnection(r.conn);return}try{await r.finalize()}catch(i){break}}this.untrackConnection(e);try{e.close()}catch(r){}}trackConnection(e){this.connections.push(e)}untrackConnection(e){const t=this.connections.indexOf(e);t!==-1&&this.connections.splice(t,1)}async*acceptConnAndIterateHttpRequests(e){if(this.closing)return;let t;try{t=await this.listener.accept()}catch(n){if(n instanceof Deno.errors.BadResource||n instanceof Deno.errors.InvalidData||n instanceof Deno.errors.UnexpectedEof||n instanceof Deno.errors.ConnectionReset)return e.add(this.acceptConnAndIterateHttpRequests(e));throw n}this.trackConnection(t),e.add(this.acceptConnAndIterateHttpRequests(e)),yield*this.iterateHttpRequests(t)}[Symbol.asyncIterator](){const e=new MuxAsyncIterator;return e.add(this.acceptConnAndIterateHttpRequests(e)),e.iterate()}}function serve(e){typeof e=="string"&&(e=_parseAddrFromStr(e));const t=Deno.listen(e);return new Server(t)}function serveTLS(e){const t={...e,transport:"tcp"},n=Deno.listenTls(t);return new Server(n)}function dew1(){if(_dewExec)return exports;_dewExec=!0,exports=t;var e=dew();function t(a){if(a=a||{},"uniqueLinkId"in a&&(console.warn("ngraph.graph: Starting from version 0.14 `uniqueLinkId` is deprecated.\nUse `multigraph` option instead\n",`
`,`Note: there is also change in default behavior: From now on each graph
is considered to be not a multigraph by default (each edge is unique).`),a.multigraph=a.uniqueLinkId),a.multigraph===void 0&&(a.multigraph=!1),typeof Map!="function")throw new Error("ngraph.graph requires `Map` to be defined. Please polyfill it before using ngraph");var c=new Map,h=[],f={},p=0,w=a.multigraph?O:F,g=[],R=x,A=x,v=x,L=x,T={addNode:N,addLink:M,removeLink:U,removeNode:D,getNode:E,getNodeCount:P,getLinkCount:I,getLinksCount:I,getNodesCount:P,getLinks:_,forEachNode:C,forEachLinkedNode:G,forEachLink:z,beginUpdate:v,endUpdate:L,clear:H,hasLink:k,hasNode:E,getLink:k};return e(T),B(),T;function B(){var l=T.on;T.on=u;function u(){return T.beginUpdate=v=W,T.endUpdate=L=Y,R=q,A=$,T.on=l,l.apply(T,arguments)}}function q(l,u){g.push({link:l,changeType:u})}function $(l,u){g.push({node:l,changeType:u})}function N(l,u){if(l===void 0)throw new Error("Invalid node identifier");v();var d=E(l);return d?(d.data=u,A(d,"update")):(d=new r(l,u),A(d,"add")),c.set(l,d),L(),d}function E(l){return c.get(l)}function D(l){var u=E(l);if(!u)return!1;v();var d=u.links;if(d){u.links=null;for(var y=0;y<d.length;++y)U(d[y])}return c.delete(l),A(u,"remove"),L(),!0}function M(l,u,d){v();var y=E(l)||N(l),m=E(u)||N(u),b=w(l,u,d);return h.push(b),o(y,b),l!==u&&o(m,b),R(b,"add"),L(),b}function F(l,u,d){var y=s(l,u);return new i(l,u,d,y)}function O(l,u,d){var y=s(l,u),m=f.hasOwnProperty(y);if(m||k(l,u)){m||(f[y]=0);var b="@"+ ++f[y];y=s(l+b,u+b)}return new i(l,u,d,y)}function P(){return c.size}function I(){return h.length}function _(l){var u=E(l);return u?u.links:null}function U(l){if(!l)return!1;var u=n(l,h);if(u<0)return!1;v(),h.splice(u,1);var d=E(l.fromId),y=E(l.toId);return d&&(u=n(l,d.links),u>=0&&d.links.splice(u,1)),y&&(u=n(l,y.links),u>=0&&y.links.splice(u,1)),R(l,"remove"),L(),!0}function k(l,u){var d=E(l),y;if(!d||!d.links)return null;for(y=0;y<d.links.length;++y){var m=d.links[y];if(m.fromId===l&&m.toId===u)return m}return null}function H(){v(),C(function(l){D(l.id)}),L()}function z(l){var u,d;if(typeof l=="function")for(u=0,d=h.length;u<d;++u)l(h[u])}function G(l,u,d){var y=E(l);if(y&&y.links&&typeof u=="function")return d?V(y.links,l,u):j(y.links,l,u)}function j(l,u,d){for(var y,m=0;m<l.length;++m){var b=l[m],K=b.fromId===u?b.toId:b.fromId;if(y=d(c.get(K),b),y)return!0}}function V(l,u,d){for(var y,m=0;m<l.length;++m){var b=l[m];if(b.fromId===u&&(y=d(c.get(b.toId),b),y))return!0}}function x(){}function W(){p+=1}function Y(){p-=1,p===0&&g.length>0&&(T.fire("changed",g),g.length=0)}function C(l){if(typeof l!="function")throw new Error("Function is expected to iterate over graph nodes. You passed "+l);for(var u=c.values(),d=u.next();!d.done;){if(l(d.value))return!0;d=u.next()}}}function n(a,c){if(!c)return-1;if(c.indexOf)return c.indexOf(a);var h=c.length,f;for(f=0;f<h;f+=1)if(c[f]===a)return f;return-1}function r(a,c){(this||_global).id=a,(this||_global).links=null,(this||_global).data=c}function o(a,c){a.links?a.links.push(c):a.links=[c]}function i(a,c,h,f){(this||_global).fromId=a,(this||_global).toId=c,(this||_global).data=h,(this||_global).id=f}function s(a,c){return a.toString()+"\u{1F449} "+c.toString()}return exports}const __default=dew1();function Timeout(e=1e4){return function(t,n,r){const o=r.value;return r.value=async function(...i){try{return await timeoutAsync.apply(this,[o,i,e])}catch(s){throw s.message==="timeout"&&(s.message=`${bold1("Timeout ("+String(e)+"ms")}) exceeded for ${brightMagenta(n+"(\u2026)")}`,Error.captureStackTrace(s,r.value)),s}},r}}function Trace(e={stack:!1}){return function(t,n,r){const o=r.value;return r.value=async function(...i){const s=new Error;Error.captureStackTrace(s,e.stack?void 0:r.value);const a=e.stack?`
`+s.stack?.split(`
`).slice(1).join(`
`):s.stack?.split(`
`).slice(1)[0].replace("at","").trim(),c=performance.now();console.info(`${brightMagenta(n+"(\u2026)")} ${bold1("called")} ${e.stack?"":"from"} ${brightCyan1(a??"n/a")} at ${bold1(new Date().toISOString())}`);let h;return o.constructor.name==="AsyncFunction"?h=await o.apply(this,i):h=o.apply(this,i),console.info(`${brightMagenta(n+"(\u2026)")} ${green("ended")} in ${brightYellow1((performance.now()-c).toFixed()+"ms")} at ${bold1(new Date().toISOString())}`),h},r}}function Retry(e){return function(n,r,o){const i=o.value;return e.backOffPolicy===BackOffPolicy.ExponentialBackOffPolicy&&(!e.backOff&&(e.backOff=1e3),e.exponentialOption={maxInterval:2e3,multiplier:2,...e.exponentialOption}),o.value=async function(...s){try{return await t.apply(this,[i,s,e.maxAttempts,e.backOff,e.doRetry])}catch(a){throw a.message==="maxAttempts"&&(a.code="429",a.message=`${brightRed1("Failed")} for ${brightMagenta(r+"(\u2026)")} for ${brightYellow1(e.maxAttempts.toString())} times.`),a}},o};async function t(n,r,o,i,s){try{return await n.apply(this,r)}catch(a){if(--o<0)throw console.error(a?.message),new Error("maxAttempts");if(s&&!s(a))throw a;if(i&&(await sleep(i),e.backOffPolicy===BackOffPolicy.ExponentialBackOffPolicy&&e.exponentialOption)){const c=i*e.exponentialOption.multiplier;i=c>e.exponentialOption.maxInterval?e.exponentialOption.maxInterval:c}return t.apply(this,[n,r,o,i,s])}}}let EgoGraph=(_class1=class e{static DEFAULT_GRAPH_DEPTH=1;static DEFAULT_SEARCH_PATTERN=" vs ";static DEFAULT_GRAPH_RADIUS=10;elapsedMs=0;maxDistance=Number.NEGATIVE_INFINITY;constructor(t={query:""}){this.graph=__default(),this.query=t.query,this.depth=t.depth??e.DEFAULT_GRAPH_DEPTH,this.pattern=t.pattern??e.DEFAULT_SEARCH_PATTERN,this.radius=t.radius??e.DEFAULT_GRAPH_RADIUS}async fetchAutocomplete(t,n){const r=t+this.pattern,o=await fetch(`http://suggestqueries.google.com/complete/search?&client=firefox&gl=us&hl=en&q=${encodeURIComponent(r)}`,fetchHeader);if(o.status===Status.OK){const i=await o.json(),s=new Set;for(const a of i[1].slice(0,n))a.split(this.pattern).slice(1).map(c=>{new RegExp("^[0-9.]+$").test(c)||s.add(c)});return s}else throw new Error(`Fetch error: ${o.status} ${o.statusText}`)}async build(){if(this.query==="")return;const t=performance.now();this.graph.beginUpdate();let n=[this.query],r=[0];for(let o=0;o<this.depth;o++){const i=[],s=[];for(let a=0;a<n.length;a++){const c=r[a];if(c>=this.radius)continue;const h=n[a],f=await this.fetchAutocomplete(h,this.radius-c);this.graph.getNode(h)||this.graph.addNode(h,{count:1,depth:h===this.query?0:o+1});let p=f.size,w=1;f.forEach(g=>{const R=c+w;R>this.maxDistance&&(this.maxDistance=R);const A=this.graph.getNode(g);if(!A)this.graph.addNode(g,{count:1,depth:o+1}),this.graph.addLink(h,g,{distance:R,weight:p,query:`${h}${this.pattern}${g}`}),s.push(R),i.push(g);else{A.data.count++;const v=this.graph.getLink(h,g),L=this.graph.getLink(g,h);v||L?v?v.data.weight+=p:L.data.weight+=p:this.graph.addLink(h,g,{distance:R,weight:p,query:`${h}${this.pattern}${g}`})}p-=1,w+=1})}n=i,r=s}this.graph.endUpdate(),this.elapsedMs=performance.now()-t}toObject(){let t=Number.NEGATIVE_INFINITY;this.graph.forEachLink(r=>{r.data.weight>t&&(t=r.data.weight)});const n={nodes:[],links:[],query:this.query,depth:this.depth,radius:this.radius,maxWeight:t,maxDistance:this.maxDistance,pattern:this.pattern,elapsedMs:this.elapsedMs};return this.graph.forEachNode(r=>{n.nodes.push({id:r.id,...r.data})}),this.graph.forEachLink(r=>{n.links.push({source:r.fromId,target:r.toId,...r.data})}),n}},_dec1=Timeout(1e3),_dec2=Retry({maxAttempts:3}),_applyDecoratedDescriptor1(_class1.prototype,"fetchAutocomplete",[_dec1,_dec2],Object.getOwnPropertyDescriptor(_class1.prototype,"fetchAutocomplete"),_class1.prototype),_dec3=Trace(),_dec4=Timeout(1e4),_applyDecoratedDescriptor1(_class1.prototype,"build",[_dec3,_dec4],Object.getOwnPropertyDescriptor(_class1.prototype,"build"),_class1.prototype),_class1),EgoNet=(_class=class{constructor(){REDIS_URL&&console.info(`${brightCyan("Redis")} is accessible at ${bold(underline(REDIS_URL))}`)}async graph(t,n){const r=new EgoGraph({query:t.query,depth:t.depth,radius:t.radius});return await r.build(),n.set("fly-cache-status","MISS"),JSON.stringify(r.toObject())}async handleQuery(t,n,r){console.log(`${brightGreen(t.method)} ${bold(t.url)}`),r.set("fly-cache-status","HIT");const o=await this.graph(n,r);return t.respond({status:Status.OK,headers:r,body:o})}handleNotAcceptable(t,n){return console.error(`${t.method} ${t.url} ${brightYellow("Not acceptable")}`),t.respond({status:Status.NotAcceptable,headers:n,body:JSON.stringify({message:"Not Acceptable"})})}handleNotFound(t,n){return console.warn(`${t.method} ${t.url} ${brightYellow("Not Found")}`),t.respond({status:Status.NotFound,headers:n,body:JSON.stringify({message:"Request Not Found"})})}handleError(t,n,r){return console.error(`${t.method} ${t.url} ${brightRed(n)}`),t.respond({status:Status.InternalServerError,headers:r,body:JSON.stringify({message:"Internal server error",error:stripColor(n)})})}async startServer(){const t=serve({hostname:SERVER_HOST,port:Number(SERVER_PORT)});console.info(`${brightCyan("Server")} is running at ${bold(underline(SERVER_HOST+":"+SERVER_PORT))}`),console.info(`Deno: ${brightGreen(Deno.version.deno)} \xB7 V8: ${brightGreen(Deno.version.v8)} \xB7 TypeScript: ${brightGreen(Deno.version.typescript)}`);for await(const n of t){const r=n.headers.get("origin"),o=new Headers;r!==null&&ALLOWED_ORIGINS.indexOf(r)!==-1&&o.set("Access-Control-Allow-Origin",r);const i=n.headers.get("host"),s=new URLSearchParams(n.url.slice(1));i!==`localhost:${SERVER_PORT}`&&!o.get("Access-Control-Allow-Origin")?this.handleNotAcceptable(n,o):n.method==="GET"&&s.get("q")?this.handleQuery(n,{query:s.get("q")??"",...s.get("d")&&{depth:Number(s.get("d"))},...s.get("r")&&{radius:Number(s.get("r"))}},o).catch(async({message:a})=>{try{await this.handleError(n,a,o)}catch(c){console.error(c)}}):this.handleNotFound(n,o)}}},_dec=Memoize({ttl:CACHE_EXPIRATION_MS,resolver:e=>`${e.query}#${e.depth??EgoGraph.DEFAULT_GRAPH_DEPTH}#${e.pattern??EgoGraph.DEFAULT_SEARCH_PATTERN}#${e.radius??EgoGraph.DEFAULT_GRAPH_RADIUS}`,onAdded:e=>{console.log(`query="${bold(e.split("#")[0])}" added to cache`)},onFound:e=>{console.log(`query="${bold(e.split("#")[0])}" served from cache`)}}),_applyDecoratedDescriptor(_class.prototype,"graph",[_dec],Object.getOwnPropertyDescriptor(_class.prototype,"graph"),_class.prototype),_class);new EgoNet().startServer();
