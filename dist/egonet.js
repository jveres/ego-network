function _applyDecoratedDescriptor(t,e,r,i,n){var s={};return Object.keys(i).forEach((function(t){s[t]=i[t]})),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=r.slice().reverse().reduce((function(r,i){return i(t,e,r)||r}),s),n&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(n):void 0,s.initializer=void 0),void 0===s.initializer&&(Object.defineProperty(t,e,s),s=null),s}var _class,_dec,_dec1,_dec2;function deferred(){let t;const e=new Promise(((e,r)=>{t={resolve:e,reject:r}}));return Object.assign(e,t)}class MuxAsyncIterator{iteratorCount=0;yields=[];throws=[];signal=deferred();add(t){++this.iteratorCount,this.callIteratorNext(t)}async callIteratorNext(t){try{const{value:e,done:r}=await t.next();r?--this.iteratorCount:this.yields.push({iterator:t,value:e})}catch(t){this.throws.push(t)}this.signal.resolve()}async*iterate(){for(;this.iteratorCount>0;){await this.signal;for(let t=0;t<this.yields.length;t++){const{iterator:e,value:r}=this.yields[t];yield r,this.callIteratorNext(e)}if(this.throws.length){for(const t of this.throws)throw t;this.throws.length=0}this.yields.length=0,this.signal=deferred()}}[Symbol.asyncIterator](){return this.iterate()}}function _parseAddrFromStr(t){let e;try{const r=t.startsWith(":")?`0.0.0.0${t}`:t;e=new URL(`http://${r}`)}catch{throw new TypeError("Invalid address.")}if(e.username||e.password||"/"!=e.pathname||e.search||e.hash)throw new TypeError("Invalid address.");return{hostname:e.hostname,port:""===e.port?80:Number(e.port)}}const CR="\r".charCodeAt(0),LF="\n".charCodeAt(0);class BufferFullError extends Error{name="BufferFullError";constructor(t){super("Buffer full"),this.partial=t}}class AbstractBufBase{usedBufferBytes=0;err=null;size(){return this.buf.byteLength}available(){return this.buf.byteLength-this.usedBufferBytes}buffered(){return this.usedBufferBytes}}function createLPS(t){const e=new Uint8Array(t.length);e[0]=0;let r=0,i=1;for(;i<e.length;)t[i]==t[r]?(r++,e[i]=r,i++):0===r?(e[i]=0,i++):r=t[r-1];return e}async function*readDelim(t,e){const r=e.length,i=createLPS(e);let n=new Deno.Buffer;const s=new Uint8Array(Math.max(1024,r+1));let a=0,o=0;for(;;){const h=await t.read(s);if(null===h)return void(yield n.bytes());if(h<0)return;const c=s.subarray(0,h);await Deno.writeAll(n,c);let u=n.bytes();for(;a<u.length;)if(u[a]===e[o]){if(a++,o++,o===r){const t=a-r,e=u.subarray(0,t),i=u.slice(a);yield e,u=i,a=0,o=0}}else 0===o?a++:o=i[o-1];n=new Deno.Buffer(u)}}async function*readStringDelim(t,e){const r=new TextEncoder,i=new TextDecoder;for await(const n of readDelim(t,r.encode(e)))yield i.decode(n)}function assert(t,e=""){if(!t)throw new DenoStdInternalError(e)}function findIndex(t,e){const r=e[0];for(let i=0;i<t.length;i++){if(t[i]!==r)continue;let n=1,s=i;for(;n<e.length&&(s++,t[s]===e[s-i]);)n++;if(n===e.length)return i}return-1}function concat(t,e){const r=new Uint8Array(t.length+e.length);return r.set(t,0),r.set(e,t.length),r}function copyBytes(t,e,r=0){r=Math.max(0,Math.min(r,e.byteLength));const i=e.byteLength-r;return t.byteLength>i&&(t=t.subarray(0,i)),e.set(t,r),t.byteLength}const invalidHeaderCharRegex=/[^\t\x20-\x7e\x80-\xff]/g;function charCode(t){return t.charCodeAt(0)}const encoder=new TextEncoder;function encode(t){return encoder.encode(t)}const decoder=new TextDecoder;function decode(t){return decoder.decode(t)}function emptyReader(){return{read:t=>Promise.resolve(null)}}function bodyReader(t,e){let r=0,i=!1;return{read:async function(n){if(i)return null;let s;const a=t-r;if(a>=n.byteLength)s=await e.read(n);else{const t=n.subarray(0,a);s=await e.read(t)}return null!==s&&(r+=s),i=r===t,s}}}function isProhibidedForTrailer(t){return new Set(["transfer-encoding","content-length","trailer"]).has(t.toLowerCase())}function parseTrailer(t){if(null==t)return;const e=t.split(",").map((t=>t.trim().toLowerCase()));if(0===e.length)throw new Deno.errors.InvalidData("Empty trailer header.");const r=e.filter((t=>isProhibidedForTrailer(t)));if(r.length>0)throw new Deno.errors.InvalidData(`Prohibited trailer names: ${Deno.inspect(r)}.`);return new Headers(e.map((t=>[t,""])))}async function writeChunkedBody(t,e){for await(const r of Deno.iter(e)){if(r.byteLength<=0)continue;const e=encoder.encode(`${r.byteLength.toString(16)}\r\n`),i=encoder.encode("\r\n");await t.write(e),await t.write(r),await t.write(i),await t.flush()}const r=encoder.encode("0\r\n\r\n");await t.write(r)}function parseHTTPVersion(t){switch(t){case"HTTP/1.1":return[1,1];case"HTTP/1.0":return[1,0];default:{if(!t.startsWith("HTTP/"))break;const e=t.indexOf(".");if(e<0)break;const r=t.substring(t.indexOf("/")+1,e),i=Number(r);if(!Number.isInteger(i)||i<0||i>1e6)break;const n=t.substring(e+1),s=Number(n);if(!Number.isInteger(s)||s<0||s>1e6)break;return[i,s]}}throw new Error(`malformed HTTP version ${t}`)}function fixLength(t){const e=t.headers.get("Content-Length");if(e){const r=e.split(",");if(r.length>1){const e=[...new Set(r.map((t=>t.trim())))];if(e.length>1)throw Error("cannot contain multiple Content-Length headers");t.headers.set("Content-Length",e[0])}const i=t.headers.get("Content-Length");if("HEAD"===t.method&&i&&"0"!==i)throw Error("http: method cannot contain a Content-Length");if(i&&t.headers.has("transfer-encoding"))throw new Error("http: Transfer-Encoding and Content-Length cannot be send together")}}class BufReader{r=0;w=0;eof=!1;static create(t,e=4096){return t instanceof BufReader?t:new BufReader(t,e)}constructor(t,e=4096){e<16&&(e=16),this._reset(new Uint8Array(e),t)}size(){return this.buf.byteLength}buffered(){return this.w-this.r}async _fill(){if(this.r>0&&(this.buf.copyWithin(0,this.r,this.w),this.w-=this.r,this.r=0),this.w>=this.buf.byteLength)throw Error("bufio: tried to fill full buffer");for(let t=100;t>0;t--){const t=await this.rd.read(this.buf.subarray(this.w));if(null===t)return void(this.eof=!0);if(assert(t>=0,"negative read"),this.w+=t,t>0)return}throw new Error("No progress after 100 read() calls")}reset(t){this._reset(this.buf,t)}_reset(t,e){this.buf=t,this.rd=e,this.eof=!1}async read(t){let e=t.byteLength;if(0===t.byteLength)return e;if(this.r===this.w){if(t.byteLength>=this.buf.byteLength){const e=await this.rd.read(t);return assert((e??0)>=0,"negative read"),e}if(this.r=0,this.w=0,e=await this.rd.read(this.buf),0===e||null===e)return e;assert(e>=0,"negative read"),this.w+=e}const r=copyBytes(this.buf.subarray(this.r,this.w),t,0);return this.r+=r,r}async readFull(t){let e=0;for(;e<t.length;)try{const r=await this.read(t.subarray(e));if(null===r){if(0===e)return null;throw new PartialReadError}e+=r}catch(r){throw r.partial=t.subarray(0,e),r}return t}async readByte(){for(;this.r===this.w;){if(this.eof)return null;await this._fill()}const t=this.buf[this.r];return this.r++,t}async readString(t){if(1!==t.length)throw new Error("Delimiter should be a single character");const e=await this.readSlice(t.charCodeAt(0));return null===e?null:(new TextDecoder).decode(e)}async readLine(){let t;try{t=await this.readSlice(LF)}catch(t){let{partial:e}=t;if(assert(e instanceof Uint8Array,"bufio: caught error from `readSlice()` without `partial` property"),!(t instanceof BufferFullError))throw t;return!this.eof&&e.byteLength>0&&e[e.byteLength-1]===CR&&(assert(this.r>0,"bufio: tried to rewind past start of buffer"),this.r--,e=e.subarray(0,e.byteLength-1)),{line:e,more:!this.eof}}if(null===t)return null;if(0===t.byteLength)return{line:t,more:!1};if(t[t.byteLength-1]==LF){let e=1;t.byteLength>1&&t[t.byteLength-2]===CR&&(e=2),t=t.subarray(0,t.byteLength-e)}return{line:t,more:!1}}async readSlice(t){let e,r=0;for(;;){let i=this.buf.subarray(this.r+r,this.w).indexOf(t);if(i>=0){i+=r,e=this.buf.subarray(this.r,this.r+i+1),this.r+=i+1;break}if(this.eof){if(this.r===this.w)return null;e=this.buf.subarray(this.r,this.w),this.r=this.w;break}if(this.buffered()>=this.buf.byteLength){this.r=this.w;const t=this.buf,e=this.buf.slice(0);throw this.buf=e,new BufferFullError(t)}r=this.w-this.r;try{await this._fill()}catch(t){throw t.partial=e,t}}return e}async peek(t){if(t<0)throw Error("negative count");let e=this.w-this.r;for(;e<t&&e<this.buf.byteLength&&!this.eof;){try{await this._fill()}catch(t){throw t.partial=this.buf.subarray(this.r,this.w),t}e=this.w-this.r}if(0===e&&this.eof)return null;if(e<t&&this.eof)return this.buf.subarray(this.r,this.r+e);if(e<t)throw new BufferFullError(this.buf.subarray(this.r,this.w));return this.buf.subarray(this.r,this.r+t)}}class BufWriter extends AbstractBufBase{static create(t,e=4096){return t instanceof BufWriter?t:new BufWriter(t,e)}constructor(t,e=4096){super(),this.writer=t,e<=0&&(e=4096),this.buf=new Uint8Array(e)}reset(t){this.err=null,this.usedBufferBytes=0,this.writer=t}async flush(){if(null!==this.err)throw this.err;if(0!==this.usedBufferBytes){try{await Deno.writeAll(this.writer,this.buf.subarray(0,this.usedBufferBytes))}catch(t){throw this.err=t,t}this.buf=new Uint8Array(this.buf.length),this.usedBufferBytes=0}}async write(t){if(null!==this.err)throw this.err;if(0===t.length)return 0;let e=0,r=0;for(;t.byteLength>this.available();){if(0===this.buffered())try{r=await this.writer.write(t)}catch(t){throw this.err=t,t}else r=copyBytes(t,this.buf,this.usedBufferBytes),this.usedBufferBytes+=r,await this.flush();e+=r,t=t.subarray(r)}return r=copyBytes(t,this.buf,this.usedBufferBytes),this.usedBufferBytes+=r,e+=r,e}}class BufWriterSync extends AbstractBufBase{static create(t,e=4096){return t instanceof BufWriterSync?t:new BufWriterSync(t,e)}constructor(t,e=4096){super(),this.writer=t,e<=0&&(e=4096),this.buf=new Uint8Array(e)}reset(t){this.err=null,this.usedBufferBytes=0,this.writer=t}flush(){if(null!==this.err)throw this.err;if(0!==this.usedBufferBytes){try{Deno.writeAllSync(this.writer,this.buf.subarray(0,this.usedBufferBytes))}catch(t){throw this.err=t,t}this.buf=new Uint8Array(this.buf.length),this.usedBufferBytes=0}}writeSync(t){if(null!==this.err)throw this.err;if(0===t.length)return 0;let e=0,r=0;for(;t.byteLength>this.available();){if(0===this.buffered())try{r=this.writer.writeSync(t)}catch(t){throw this.err=t,t}else r=copyBytes(t,this.buf,this.usedBufferBytes),this.usedBufferBytes+=r,this.flush();e+=r,t=t.subarray(r)}return r=copyBytes(t,this.buf,this.usedBufferBytes),this.usedBufferBytes+=r,e+=r,e}}function str(t){return null==t?"":decode(t)}class TextProtoReader{constructor(t){this.r=t}async readLine(){const t=await this.readLineSlice();return null===t?null:str(t)}async readMIMEHeader(){const t=new Headers;let e,r=await this.r.peek(1);if(null===r)return null;if(r[0]!=charCode(" ")&&r[0]!=charCode("\t")||(e=await this.readLineSlice()),r=await this.r.peek(1),null===r)throw new Deno.errors.UnexpectedEof;if(r[0]==charCode(" ")||r[0]==charCode("\t"))throw new Deno.errors.InvalidData(`malformed MIME header initial line: ${str(e)}`);for(;;){const e=await this.readLineSlice();if(null===e)throw new Deno.errors.UnexpectedEof;if(0===e.byteLength)return t;let r=e.indexOf(charCode(":"));if(r<0)throw new Deno.errors.InvalidData(`malformed MIME header line: ${str(e)}`);const i=str(e.subarray(0,r));if(""==i)continue;for(r++;r<e.byteLength&&(e[r]==charCode(" ")||e[r]==charCode("\t"));)r++;const n=str(e.subarray(r)).replace(invalidHeaderCharRegex,encodeURI);try{t.append(i,n)}catch{}}}async readLineSlice(){let t;for(;;){const e=await this.r.readLine();if(null===e)return null;const{line:r,more:i}=e;if(!t&&!i)return 0===this.skipSpace(r)?new Uint8Array(0):r;if(t=t?concat(t,r):r,!i)break}return t}skipSpace(t){let e=0;for(let r=0;r<t.length;r++)t[r]!==charCode(" ")&&t[r]!==charCode("\t")&&e++;return e}}async function readTrailers(t,e){const r=parseTrailer(t.get("trailer"));if(null==r)return;const i=[...r.keys()],n=new TextProtoReader(e),s=await n.readMIMEHeader();if(null==s)throw new Deno.errors.InvalidData("Missing trailer header.");const a=[...s.keys()].filter((t=>!i.includes(t)));if(a.length>0)throw new Deno.errors.InvalidData(`Undeclared trailers: ${Deno.inspect(a)}.`);for(const[e,r]of s)t.append(e,r);const o=i.filter((t=>!s.has(t)));if(o.length>0)throw new Deno.errors.InvalidData(`Missing trailers: ${Deno.inspect(o)}.`);t.delete("trailer")}async function writeTrailers(t,e,r){const i=e.get("trailer");if(null===i)throw new TypeError("Missing trailer header.");const n=e.get("transfer-encoding");if(null===n||!n.match(/^chunked/))throw new TypeError(`Trailers are only allowed for "transfer-encoding: chunked", got "transfer-encoding: ${n}".`);const s=BufWriter.create(t),a=i.split(",").map((t=>t.trim().toLowerCase())),o=a.filter((t=>isProhibidedForTrailer(t)));if(o.length>0)throw new TypeError(`Prohibited trailer names: ${Deno.inspect(o)}.`);const h=[...r.keys()].filter((t=>!a.includes(t)));if(h.length>0)throw new TypeError(`Undeclared trailers: ${Deno.inspect(h)}.`);for(const[t,e]of r)await s.write(encoder.encode(`${t}: ${e}\r\n`));await s.write(encoder.encode("\r\n")),await s.flush()}function chunkedBodyReader(t,e){const r=new TextProtoReader(e);let i=!1;const n=[];return{read:async function(s){if(i)return null;const[a]=n;if(a){const t=a.data.byteLength-a.offset,e=Math.min(t,s.byteLength);for(let t=0;t<e;t++)s[t]=a.data[a.offset+t];if(a.offset+=e,a.offset===a.data.byteLength&&(n.shift(),null===await r.readLine()))throw new Deno.errors.UnexpectedEof;return e}const o=await r.readLine();if(null===o)throw new Deno.errors.UnexpectedEof;const[h]=o.split(";"),c=parseInt(h,16);if(Number.isNaN(c)||c<0)throw new Deno.errors.InvalidData("Invalid chunk size");if(c>0){if(c>s.byteLength){let t=await e.readFull(s);if(null===t)throw new Deno.errors.UnexpectedEof;const r=new Uint8Array(c-s.byteLength);if(t=await e.readFull(r),null===t)throw new Deno.errors.UnexpectedEof;return n.push({offset:0,data:r}),s.byteLength}{const t=s.subarray(0,c);if(null===await e.readFull(t))throw new Deno.errors.UnexpectedEof;if(null===await r.readLine())throw new Deno.errors.UnexpectedEof;return c}}if(assert(0===c),null===await e.readLine())throw new Deno.errors.UnexpectedEof;return await readTrailers(t,e),i=!0,null}}}var Status;!function(t){t[t.Continue=100]="Continue",t[t.SwitchingProtocols=101]="SwitchingProtocols",t[t.Processing=102]="Processing",t[t.EarlyHints=103]="EarlyHints",t[t.OK=200]="OK",t[t.Created=201]="Created",t[t.Accepted=202]="Accepted",t[t.NonAuthoritativeInfo=203]="NonAuthoritativeInfo",t[t.NoContent=204]="NoContent",t[t.ResetContent=205]="ResetContent",t[t.PartialContent=206]="PartialContent",t[t.MultiStatus=207]="MultiStatus",t[t.AlreadyReported=208]="AlreadyReported",t[t.IMUsed=226]="IMUsed",t[t.MultipleChoices=300]="MultipleChoices",t[t.MovedPermanently=301]="MovedPermanently",t[t.Found=302]="Found",t[t.SeeOther=303]="SeeOther",t[t.NotModified=304]="NotModified",t[t.UseProxy=305]="UseProxy",t[t.TemporaryRedirect=307]="TemporaryRedirect",t[t.PermanentRedirect=308]="PermanentRedirect",t[t.BadRequest=400]="BadRequest",t[t.Unauthorized=401]="Unauthorized",t[t.PaymentRequired=402]="PaymentRequired",t[t.Forbidden=403]="Forbidden",t[t.NotFound=404]="NotFound",t[t.MethodNotAllowed=405]="MethodNotAllowed",t[t.NotAcceptable=406]="NotAcceptable",t[t.ProxyAuthRequired=407]="ProxyAuthRequired",t[t.RequestTimeout=408]="RequestTimeout",t[t.Conflict=409]="Conflict",t[t.Gone=410]="Gone",t[t.LengthRequired=411]="LengthRequired",t[t.PreconditionFailed=412]="PreconditionFailed",t[t.RequestEntityTooLarge=413]="RequestEntityTooLarge",t[t.RequestURITooLong=414]="RequestURITooLong",t[t.UnsupportedMediaType=415]="UnsupportedMediaType",t[t.RequestedRangeNotSatisfiable=416]="RequestedRangeNotSatisfiable",t[t.ExpectationFailed=417]="ExpectationFailed",t[t.Teapot=418]="Teapot",t[t.MisdirectedRequest=421]="MisdirectedRequest",t[t.UnprocessableEntity=422]="UnprocessableEntity",t[t.Locked=423]="Locked",t[t.FailedDependency=424]="FailedDependency",t[t.TooEarly=425]="TooEarly",t[t.UpgradeRequired=426]="UpgradeRequired",t[t.PreconditionRequired=428]="PreconditionRequired",t[t.TooManyRequests=429]="TooManyRequests",t[t.RequestHeaderFieldsTooLarge=431]="RequestHeaderFieldsTooLarge",t[t.UnavailableForLegalReasons=451]="UnavailableForLegalReasons",t[t.InternalServerError=500]="InternalServerError",t[t.NotImplemented=501]="NotImplemented",t[t.BadGateway=502]="BadGateway",t[t.ServiceUnavailable=503]="ServiceUnavailable",t[t.GatewayTimeout=504]="GatewayTimeout",t[t.HTTPVersionNotSupported=505]="HTTPVersionNotSupported",t[t.VariantAlsoNegotiates=506]="VariantAlsoNegotiates",t[t.InsufficientStorage=507]="InsufficientStorage",t[t.LoopDetected=508]="LoopDetected",t[t.NotExtended=510]="NotExtended",t[t.NetworkAuthenticationRequired=511]="NetworkAuthenticationRequired"}(Status||(Status={}));const STATUS_TEXT=new Map([[Status.Continue,"Continue"],[Status.SwitchingProtocols,"Switching Protocols"],[Status.Processing,"Processing"],[Status.EarlyHints,"Early Hints"],[Status.OK,"OK"],[Status.Created,"Created"],[Status.Accepted,"Accepted"],[Status.NonAuthoritativeInfo,"Non-Authoritative Information"],[Status.NoContent,"No Content"],[Status.ResetContent,"Reset Content"],[Status.PartialContent,"Partial Content"],[Status.MultiStatus,"Multi-Status"],[Status.AlreadyReported,"Already Reported"],[Status.IMUsed,"IM Used"],[Status.MultipleChoices,"Multiple Choices"],[Status.MovedPermanently,"Moved Permanently"],[Status.Found,"Found"],[Status.SeeOther,"See Other"],[Status.NotModified,"Not Modified"],[Status.UseProxy,"Use Proxy"],[Status.TemporaryRedirect,"Temporary Redirect"],[Status.PermanentRedirect,"Permanent Redirect"],[Status.BadRequest,"Bad Request"],[Status.Unauthorized,"Unauthorized"],[Status.PaymentRequired,"Payment Required"],[Status.Forbidden,"Forbidden"],[Status.NotFound,"Not Found"],[Status.MethodNotAllowed,"Method Not Allowed"],[Status.NotAcceptable,"Not Acceptable"],[Status.ProxyAuthRequired,"Proxy Authentication Required"],[Status.RequestTimeout,"Request Timeout"],[Status.Conflict,"Conflict"],[Status.Gone,"Gone"],[Status.LengthRequired,"Length Required"],[Status.PreconditionFailed,"Precondition Failed"],[Status.RequestEntityTooLarge,"Request Entity Too Large"],[Status.RequestURITooLong,"Request URI Too Long"],[Status.UnsupportedMediaType,"Unsupported Media Type"],[Status.RequestedRangeNotSatisfiable,"Requested Range Not Satisfiable"],[Status.ExpectationFailed,"Expectation Failed"],[Status.Teapot,"I'm a teapot"],[Status.MisdirectedRequest,"Misdirected Request"],[Status.UnprocessableEntity,"Unprocessable Entity"],[Status.Locked,"Locked"],[Status.FailedDependency,"Failed Dependency"],[Status.TooEarly,"Too Early"],[Status.UpgradeRequired,"Upgrade Required"],[Status.PreconditionRequired,"Precondition Required"],[Status.TooManyRequests,"Too Many Requests"],[Status.RequestHeaderFieldsTooLarge,"Request Header Fields Too Large"],[Status.UnavailableForLegalReasons,"Unavailable For Legal Reasons"],[Status.InternalServerError,"Internal Server Error"],[Status.NotImplemented,"Not Implemented"],[Status.BadGateway,"Bad Gateway"],[Status.ServiceUnavailable,"Service Unavailable"],[Status.GatewayTimeout,"Gateway Timeout"],[Status.HTTPVersionNotSupported,"HTTP Version Not Supported"],[Status.VariantAlsoNegotiates,"Variant Also Negotiates"],[Status.InsufficientStorage,"Insufficient Storage"],[Status.LoopDetected,"Loop Detected"],[Status.NotExtended,"Not Extended"],[Status.NetworkAuthenticationRequired,"Network Authentication Required"]]),noColor=globalThis.Deno?.noColor??!0;let enabled=!noColor;function code(t,e){return{open:`[${t.join(";")}m`,close:`[${e}m`,regexp:new RegExp(`\\x1b\\[${e}m`,"g")}}function run(t,e){return enabled?`${e.open}${t.replace(e.regexp,e.open)}${e.close}`:t}function bold(t){return run(t,code([1],22))}function underline(t){return run(t,code([4],24))}function green(t){return run(t,code([32],39))}function brightBlack(t){return run(t,code([90],39))}function brightRed(t){return run(t,code([91],39))}function brightGreen(t){return run(t,code([92],39))}function brightYellow(t){return run(t,code([93],39))}function brightMagenta(t){return run(t,code([95],39))}function brightCyan(t){return run(t,code([96],39))}function clampAndTruncate(t,e=255,r=0){return Math.trunc(Math.max(Math.min(t,e),r))}const ANSI_PATTERN=new RegExp(["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:[a-zA-Z\\d]*(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-ntqry=><~]))"].join("|"),"g");function stripColor(t){return t.replace(ANSI_PATTERN,"")}function _applyDecoratedDescriptor1(t,e,r,i,n){var s={};return Object.keys(i).forEach((function(t){s[t]=i[t]})),s.enumerable=!!s.enumerable,s.configurable=!!s.configurable,("value"in s||s.initializer)&&(s.writable=!0),s=r.slice().reverse().reduce((function(r,i){return i(t,e,r)||r}),s),n&&void 0!==s.initializer&&(s.value=s.initializer?s.initializer.call(n):void 0,s.initializer=void 0),void 0===s.initializer&&(Object.defineProperty(t,e,s),s=null),s}var _class1,_dec3,_dec4,_dec5,_dec6,BackOffPolicy,exports={},_dewExec=!1,_global="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:global,exports1={},_dewExec1=!1;function dew(){if(_dewExec1)return exports1;return _dewExec1=!0,exports1=function(t){!function(t){if(!t)throw new Error("Eventify cannot use falsy object as events subject");for(var e=["on","fire","off"],r=0;r<e.length;++r)if(t.hasOwnProperty(e[r]))throw new Error("Subject cannot be eventified, since it already has property '"+e[r]+"'")}(t);var e=function(t){var e=Object.create(null);return{on:function(r,i,n){if("function"!=typeof i)throw new Error("callback is expected to be a function");var s=e[r];return s||(s=e[r]=[]),s.push({callback:i,ctx:n}),t},off:function(r,i){if(void 0===r)return e=Object.create(null),t;if(e[r])if("function"!=typeof i)delete e[r];else for(var n=e[r],s=0;s<n.length;++s)n[s].callback===i&&n.splice(s,1);return t},fire:function(r){var i,n=e[r];if(!n)return t;arguments.length>1&&(i=Array.prototype.splice.call(arguments,1));for(var s=0;s<n.length;++s){var a=n[s];a.callback.apply(a.ctx,i)}return t}}}(t);return t.on=e.on,t.off=e.off,t.fire=e.fire,t}}function timeoutAsync(t,e,r){let i;return Promise.race([new Promise(((t,e)=>{i=setTimeout((()=>{clearTimeout(i),e(new Error("timeout"))}),r)})),t.apply(this,e)]).then((t=>(clearTimeout(i),t)))}function Trace(t={stack:!1}){return function(e,r,i){const n=i.value;let s;return i.value=async function(...e){const a=new Error;Error.captureStackTrace(a,t.stack?void 0:i.value);const o=t.stack?"\n"+a.stack?.split("\n").slice(1).join("\n"):a.stack?.split("\n").slice(1)[0]?.replace("at","").trim(),h=performance.now();let c;return console.log(`${brightMagenta(r+"(…)")} ${bold("called")} ${t.stack?"":"from"} ${brightCyan(o??s??"unknown")} at ${bold((new Date).toISOString())}`),o&&(s=o),c="AsyncFunction"===n.constructor.name?await n.apply(this,e):n.apply(this,e),console.log(`${brightMagenta(r+"(…)")} ${green("ended")} in ${brightYellow((performance.now()-h).toFixed()+"ms")} at ${bold((new Date).toISOString())}`),c},i}}!function(t){t.FixedBackOffPolicy="FixedBackOffPolicy",t.ExponentialBackOffPolicy="ExponentialBackOffPolicy"}(BackOffPolicy||(BackOffPolicy={}));const sleep=t=>new Promise((e=>setTimeout(e,t)));class LruCache{values=new Map;maxEntries=500;get(t){const e=this.values.get(t);return void 0!==e&&(this.values.delete(t),this.values.set(t,e)),e}has(t){return this.values.has(t)}put(t,e){if(this.values.size>=this.maxEntries){const t=this.values.keys().next().value;this.values.delete(t)}this.values.set(t,e)}}class RateLimitError extends Error{}class Dequeue{_length=0;head=void 0;tail=void 0;get length(){return this._length}clear(){this.head=this.tail=void 0,this._length=0}push(t){const e={value:t,prev:this.tail,next:void 0};this._length?(this.tail&&(this.tail.next=e),this.tail=e):this.head=this.tail=e,this._length++}pop(){if(!this._length)return;const t=this.tail;return this.tail=this.tail?.prev,this._length--,this._length||(this.head=this.tail=void 0),t?.value}unshift(t){const e={value:t,prev:void 0,next:this.head};this._length?(this.head&&(this.head.prev=e),this.head=e):this.head=this.tail=e,this._length++}shift(){if(!this._length)return;const t=this.head;return this.head=this.head?.next,this._length--,this._length||(this.head=this.tail=void 0),t?.value}peekFront(){if(this._length)return this.head?.value}peekBack(){if(this._length)return this.tail?.value}}class QuotaManager{_activeCount=0;history=new Dequeue;constructor(t={interval:1e3,rate:1,concurrency:1,maxDelay:1}){this._quota=t}get quota(){return Object.assign({},this._quota)}get activeCount(){return this._activeCount}get maxDelay(){return this._quota.maxDelay}start(){if(void 0!==this._quota.concurrency&&this._activeCount>=this._quota.concurrency)return!1;if(void 0!==this._quota.interval&&void 0!==this._quota.rate){if(this.removeExpiredHistory(),this.history.length>=this._quota.rate)return!1;this.history.push(Date.now())}return this._activeCount++,!0}end(){this._activeCount--}removeExpiredHistory(){if(!this._quota.interval)return;const t=Date.now()-this._quota.interval;for(;this.history.length&&this.history.peekFront()<t;)this.history.shift()}}function rateLimit(t){if(!(t instanceof QuotaManager))return rateLimit(new QuotaManager(t));const e=new Dequeue;let r=null;const i=()=>{for(;e.length&&t.start();){const t=e.shift();t&&t()}!e.length||t.activeCount||r||(r=setTimeout((()=>{r=null,i()}),100))};return r=>new Promise(((n,s)=>{let a=null;t.maxDelay&&(a=setTimeout((()=>{a=null,s(new RateLimitError("queue timemout exceeded")),i()}),t.maxDelay));e.push((()=>{if(t.maxDelay){if(!a)return;clearTimeout(a)}r().then((t=>{n(t)})).catch((t=>{s(t)})).then((()=>{t.end(),i()}))})),i()}))}const fetchHeader={headers:{}},httpProxy=Deno.env.get("HTTP_PROXY");if(httpProxy){const t=new URL(httpProxy);fetchHeader.headers={Authorization:`Basic ${btoa(t.username+":"+t.password)}`},console.info(`Using HTTP_PROXY (origin="${t.origin}", Authorization="Basic ***...***")`)}function timeoutAsync1(t,e,r){let i;return Promise.race([new Promise(((t,e)=>{i=setTimeout((()=>{clearTimeout(i),e(new Error("timeout"))}),r)})),t.apply(this,e)]).then((t=>(clearTimeout(i),t)))}var BackOffPolicy1;!function(t){t.FixedBackOffPolicy="FixedBackOffPolicy",t.ExponentialBackOffPolicy="ExponentialBackOffPolicy"}(BackOffPolicy1||(BackOffPolicy1={}));class RateLimitError1 extends Error{}function Try(){return function(t,e,r){const i=r.value;return r.value=async function(...t){try{return await i.apply(this,t)}catch{}},r}}var exports2={},_dewExec2=!1;function dew1(){if(_dewExec2)return exports2;function t(t){this._head=0,this._tail=0,this._capacityMask=3,this._list=new Array(4),Array.isArray(t)&&this._fromArray(t)}return _dewExec2=!0,t.prototype.peekAt=function(t){var e=t;if(e===(0|e)){var r=this.size();if(!(e>=r||e<-r))return e<0&&(e+=r),e=this._head+e&this._capacityMask,this._list[e]}},t.prototype.get=function(t){return this.peekAt(t)},t.prototype.peek=function(){if(this._head!==this._tail)return this._list[this._head]},t.prototype.peekFront=function(){return this.peek()},t.prototype.peekBack=function(){return this.peekAt(-1)},Object.defineProperty(t.prototype,"length",{get:function(){return this.size()}}),t.prototype.size=function(){return this._head===this._tail?0:this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},t.prototype.unshift=function(t){if(void 0===t)return this.size();var e=this._list.length;return this._head=this._head-1+e&this._capacityMask,this._list[this._head]=t,this._tail===this._head&&this._growArray(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},t.prototype.shift=function(){var t=this._head;if(t!==this._tail){var e=this._list[t];return this._list[t]=void 0,this._head=t+1&this._capacityMask,t<2&&this._tail>1e4&&this._tail<=this._list.length>>>2&&this._shrinkArray(),e}},t.prototype.push=function(t){if(void 0===t)return this.size();var e=this._tail;return this._list[e]=t,this._tail=e+1&this._capacityMask,this._tail===this._head&&this._growArray(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)},t.prototype.pop=function(){var t=this._tail;if(t!==this._head){var e=this._list.length;this._tail=t-1+e&this._capacityMask;var r=this._list[this._tail];return this._list[this._tail]=void 0,this._head<2&&t>1e4&&t<=e>>>2&&this._shrinkArray(),r}},t.prototype.removeOne=function(t){var e=t;if(e===(0|e)&&this._head!==this._tail){var r=this.size(),i=this._list.length;if(!(e>=r||e<-r)){e<0&&(e+=r),e=this._head+e&this._capacityMask;var n,s=this._list[e];if(t<r/2){for(n=t;n>0;n--)this._list[e]=this._list[e=e-1+i&this._capacityMask];this._list[e]=void 0,this._head=this._head+1+i&this._capacityMask}else{for(n=r-1-t;n>0;n--)this._list[e]=this._list[e=e+1+i&this._capacityMask];this._list[e]=void 0,this._tail=this._tail-1+i&this._capacityMask}return s}}},t.prototype.remove=function(t,e){var r,i=t,n=e;if(i===(0|i)&&this._head!==this._tail){var s=this.size(),a=this._list.length;if(!(i>=s||i<-s||e<1)){if(i<0&&(i+=s),1===e||!e)return(r=new Array(1))[0]=this.removeOne(i),r;if(0===i&&i+e>=s)return r=this.toArray(),this.clear(),r;var o;for(i+e>s&&(e=s-i),r=new Array(e),o=0;o<e;o++)r[o]=this._list[this._head+i+o&this._capacityMask];if(i=this._head+i&this._capacityMask,t+e===s){for(this._tail=this._tail-e+a&this._capacityMask,o=e;o>0;o--)this._list[i=i+1+a&this._capacityMask]=void 0;return r}if(0===t){for(this._head=this._head+e+a&this._capacityMask,o=e-1;o>0;o--)this._list[i=i+1+a&this._capacityMask]=void 0;return r}if(i<s/2){for(this._head=this._head+t+e+a&this._capacityMask,o=t;o>0;o--)this.unshift(this._list[i=i-1+a&this._capacityMask]);for(i=this._head-1+a&this._capacityMask;n>0;)this._list[i=i-1+a&this._capacityMask]=void 0,n--;t<0&&(this._tail=i)}else{for(this._tail=i,i=i+e+a&this._capacityMask,o=s-(e+t);o>0;o--)this.push(this._list[i++]);for(i=this._tail;n>0;)this._list[i=i+1+a&this._capacityMask]=void 0,n--}return this._head<2&&this._tail>1e4&&this._tail<=a>>>2&&this._shrinkArray(),r}}},t.prototype.splice=function(t,e){var r=t;if(r===(0|r)){var i=this.size();if(r<0&&(r+=i),!(r>i)){if(arguments.length>2){var n,s,a,o=arguments.length,h=this._list.length,c=2;if(!i||r<i/2){for(s=new Array(r),n=0;n<r;n++)s[n]=this._list[this._head+n&this._capacityMask];for(0===e?(a=[],r>0&&(this._head=this._head+r+h&this._capacityMask)):(a=this.remove(r,e),this._head=this._head+r+h&this._capacityMask);o>c;)this.unshift(arguments[--o]);for(n=r;n>0;n--)this.unshift(s[n-1])}else{var u=(s=new Array(i-(r+e))).length;for(n=0;n<u;n++)s[n]=this._list[this._head+r+e+n&this._capacityMask];for(0===e?(a=[],r!=i&&(this._tail=this._head+r+h&this._capacityMask)):(a=this.remove(r,e),this._tail=this._tail-u+h&this._capacityMask);c<o;)this.push(arguments[c++]);for(n=0;n<u;n++)this.push(s[n])}return a}return this.remove(r,e)}}},t.prototype.clear=function(){this._head=0,this._tail=0},t.prototype.isEmpty=function(){return this._head===this._tail},t.prototype.toArray=function(){return this._copyArray(!1)},t.prototype._fromArray=function(t){for(var e=0;e<t.length;e++)this.push(t[e])},t.prototype._copyArray=function(t){var e,r=[],i=this._list,n=i.length;if(t||this._head>this._tail){for(e=this._head;e<n;e++)r.push(i[e]);for(e=0;e<this._tail;e++)r.push(i[e])}else for(e=this._head;e<this._tail;e++)r.push(i[e]);return r},t.prototype._growArray=function(){this._head&&(this._list=this._copyArray(!0),this._head=0),this._tail=this._list.length,this._list.length*=2,this._capacityMask=this._capacityMask<<1|1},t.prototype._shrinkArray=function(){this._list.length>>>=1,this._capacityMask>>>=1},exports2=t}const __default=dew1(),sleep1=t=>new Promise((e=>setTimeout(e,t)));class LruCache1{values=new Map;maxEntries=500;get(t){const e=this.values.get(t);return void 0!==e&&(this.values.delete(t),this.values.set(t,e)),e}has(t){return this.values.has(t)}put(t,e){if(this.values.size>=this.maxEntries){const t=this.values.keys().next().value;this.values.delete(t)}this.values.set(t,e)}}const SERVER_HOST="0.0.0.0",SERVER_PORT=Deno.env.get("PORT")??"8080",REDIS_URL=Deno.env.get("FLY_REDIS_CACHE_URL"),ALLOWED_ORIGINS=["https://ego.jveres.me"],CACHE_EXPIRATION_MS=432e5;async function writeResponse(t,e){const r=e.status||200,i=STATUS_TEXT.get(r),n=BufWriter.create(t);if(!i)throw new Deno.errors.InvalidData("Bad status code");e.body||(e.body=new Uint8Array),"string"==typeof e.body&&(e.body=encoder.encode(e.body));let s=`HTTP/1.1 ${r} ${i}\r\n`;const a=e.headers??new Headers;e.body&&!a.get("content-length")&&(e.body instanceof Uint8Array?s+=`content-length: ${e.body.byteLength}\r\n`:a.get("transfer-encoding")||(s+="transfer-encoding: chunked\r\n"));for(const[t,e]of a)s+=`${t}: ${e}\r\n`;s+="\r\n";const o=encoder.encode(s);if(assert(await n.write(o)===o.byteLength),e.body instanceof Uint8Array){assert(await n.write(e.body)===e.body.byteLength)}else if(a.has("content-length")){const t=a.get("content-length");assert(null!=t);const r=parseInt(t);assert(await Deno.copy(e.body,n)===r)}else await writeChunkedBody(n,e.body);if(e.trailers){const t=await e.trailers();await writeTrailers(n,a,t)}await n.flush()}class ServerRequest{done=deferred();_contentLength=void 0;get contentLength(){if(void 0===this._contentLength){const t=this.headers.get("content-length");t?(this._contentLength=parseInt(t),Number.isNaN(this._contentLength)&&(this._contentLength=null)):this._contentLength=null}return this._contentLength}_body=null;get body(){if(!this._body)if(null!=this.contentLength)this._body=bodyReader(this.contentLength,this.r);else{const t=this.headers.get("transfer-encoding");if(null!=t){assert(t.split(",").map((t=>t.trim().toLowerCase())).includes("chunked"),'transfer-encoding must include "chunked" if content-length is not set'),this._body=chunkedBodyReader(this.headers,this.r)}else this._body=emptyReader()}return this._body}async respond(t){let e;try{await writeResponse(this.w,t)}catch(t){try{this.conn.close()}catch{}e=t}if(this.done.resolve(e),e)throw e}finalized=!1;async finalize(){if(this.finalized)return;const t=this.body,e=new Uint8Array(1024);for(;null!==await t.read(e););this.finalized=!0}}async function readRequest(t,e){const r=new TextProtoReader(e),i=await r.readLine();if(null===i)return null;const n=await r.readMIMEHeader();if(null===n)throw new Deno.errors.UnexpectedEof;const s=new ServerRequest;return s.conn=t,s.r=e,[s.method,s.url,s.proto]=i.split(" ",3),[s.protoMinor,s.protoMajor]=parseHTTPVersion(s.proto),s.headers=n,fixLength(s),s}class Server{closing=!1;connections=[];constructor(t){this.listener=t}close(){this.closing=!0,this.listener.close();for(const t of this.connections)try{t.close()}catch(t){if(!(t instanceof Deno.errors.BadResource))throw t}}async*iterateHttpRequests(t){const e=new BufReader(t),r=new BufWriter(t);for(;!this.closing;){let i;try{i=await readRequest(t,e)}catch(t){if(t instanceof Deno.errors.InvalidData||t instanceof Deno.errors.UnexpectedEof)try{await writeResponse(r,{status:400,body:encode(`${t.message}\r\n\r\n`)})}catch(t){}break}if(null===i)break;i.w=r,yield i;if(await i.done)return void this.untrackConnection(i.conn);try{await i.finalize()}catch(t){break}}this.untrackConnection(t);try{t.close()}catch(t){}}trackConnection(t){this.connections.push(t)}untrackConnection(t){const e=this.connections.indexOf(t);-1!==e&&this.connections.splice(e,1)}async*acceptConnAndIterateHttpRequests(t){if(this.closing)return;let e;try{e=await this.listener.accept()}catch(e){if(e instanceof Deno.errors.BadResource||e instanceof Deno.errors.InvalidData||e instanceof Deno.errors.UnexpectedEof||e instanceof Deno.errors.ConnectionReset)return t.add(this.acceptConnAndIterateHttpRequests(t));throw e}this.trackConnection(e),t.add(this.acceptConnAndIterateHttpRequests(t)),yield*this.iterateHttpRequests(e)}[Symbol.asyncIterator](){const t=new MuxAsyncIterator;return t.add(this.acceptConnAndIterateHttpRequests(t)),t.iterate()}}function serve(t){"string"==typeof t&&(t=_parseAddrFromStr(t));const e=Deno.listen(t);return new Server(e)}function serveTLS(t){const e={...t,transport:"tcp"},r=Deno.listenTls(e);return new Server(r)}function dew2(){if(_dewExec)return exports;_dewExec=!0,exports=function(a){"uniqueLinkId"in(a=a||{})&&(console.warn("ngraph.graph: Starting from version 0.14 `uniqueLinkId` is deprecated.\nUse `multigraph` option instead\n","\n","Note: there is also change in default behavior: From now on each graph\nis considered to be not a multigraph by default (each edge is unique)."),a.multigraph=a.uniqueLinkId);void 0===a.multigraph&&(a.multigraph=!1);if("function"!=typeof Map)throw new Error("ngraph.graph requires `Map` to be defined. Please polyfill it before using ngraph");var o=new Map,h=[],c={},u=0,l=a.multigraph?function(t,e,r){var i=s(t,e),a=c.hasOwnProperty(i);if(a||T(t,e)){a||(c[i]=0);var o="@"+ ++c[i];i=s(t+o,e+o)}return new n(t,e,r,i)}:function(t,e,r){var i=s(t,e);return new n(t,e,r,i)},d=[],f=A,p=A,y=A,g=A,w={addNode:v,addLink:function(t,e,r){y();var n=m(t)||v(t),s=m(e)||v(e),a=l(t,e,r);h.push(a),i(n,a),t!==e&&i(s,a);return f(a,"add"),g(),a},removeLink:k,removeNode:R,getNode:m,getNodeCount:S,getLinkCount:E,getLinksCount:E,getNodesCount:S,getLinks:function(t){var e=m(t);return e?e.links:null},forEachNode:D,forEachLinkedNode:function(t,e,r){var i=m(t);if(i&&i.links&&"function"==typeof e)return r?function(t,e,r){for(var i=0;i<t.length;++i){var n=t[i];if(n.fromId===e&&r(o.get(n.toId),n))return!0}}(i.links,t,e):function(t,e,r){for(var i=0;i<t.length;++i){var n=t[i],s=n.fromId===e?n.toId:n.fromId;if(r(o.get(s),n))return!0}}(i.links,t,e)},forEachLink:function(t){var e,r;if("function"==typeof t)for(e=0,r=h.length;e<r;++e)t(h[e])},beginUpdate:y,endUpdate:g,clear:function(){y(),D((function(t){R(t.id)})),g()},hasLink:T,hasNode:m,getLink:T};return t(w),function(){var t=w.on;function e(){return w.beginUpdate=y=x,w.endUpdate=g=L,f=_,p=b,w.on=t,t.apply(w,arguments)}w.on=e}(),w;function _(t,e){d.push({link:t,changeType:e})}function b(t,e){d.push({node:t,changeType:e})}function v(t,e){if(void 0===t)throw new Error("Invalid node identifier");y();var i=m(t);return i?(i.data=e,p(i,"update")):(i=new r(t,e),p(i,"add")),o.set(t,i),g(),i}function m(t){return o.get(t)}function R(t){var e=m(t);if(!e)return!1;y();var r=e.links;if(r){e.links=null;for(var i=0;i<r.length;++i)k(r[i])}return o.delete(t),p(e,"remove"),g(),!0}function S(){return o.size}function E(){return h.length}function k(t){if(!t)return!1;var r=e(t,h);if(r<0)return!1;y(),h.splice(r,1);var i=m(t.fromId),n=m(t.toId);return i&&(r=e(t,i.links))>=0&&i.links.splice(r,1),n&&(r=e(t,n.links))>=0&&n.links.splice(r,1),f(t,"remove"),g(),!0}function T(t,e){var r,i=m(t);if(!i||!i.links)return null;for(r=0;r<i.links.length;++r){var n=i.links[r];if(n.fromId===t&&n.toId===e)return n}return null}function A(){}function x(){u+=1}function L(){0===(u-=1)&&d.length>0&&(w.fire("changed",d),d.length=0)}function D(t){if("function"!=typeof t)throw new Error("Function is expected to iterate over graph nodes. You passed "+t);for(var e=o.values(),r=e.next();!r.done;){if(t(r.value))return!0;r=e.next()}}};var t=dew();function e(t,e){if(!e)return-1;if(e.indexOf)return e.indexOf(t);var r,i=e.length;for(r=0;r<i;r+=1)if(e[r]===t)return r;return-1}function r(t,e){(this||_global).id=t,(this||_global).links=null,(this||_global).data=e}function i(t,e){t.links?t.links.push(e):t.links=[e]}function n(t,e,r,i){(this||_global).fromId=t,(this||_global).toId=e,(this||_global).data=r,(this||_global).id=i}function s(t,e){return t.toString()+"👉 "+e.toString()}return exports}const __default1=dew2();function Timeout(t=1e4){return function(e,r,i){const n=i.value;return i.value=async function(...e){try{return await timeoutAsync.apply(this,[n,e,t])}catch(e){throw"timeout"===e.message&&(e.message=`${bold("Timeout ("+String(t)+"ms")}) exceeded for ${brightMagenta(r+"(…)")}`,Error.captureStackTrace(e,i.value)),e}},i}}function Retry(t={maxAttempts:3}){return function(r,i,n){const s=n.value;return t.backOffPolicy===BackOffPolicy.ExponentialBackOffPolicy&&(!t.backOff&&(t.backOff=1e3),t.exponentialOption={maxInterval:2e3,multiplier:2,...t.exponentialOption}),n.value=async function(...r){try{return await e.apply(this,[s,r,t.maxAttempts,t.backOff,t.doRetry])}catch(e){throw"maxAttempts"===e.message&&(e.code="429",e.message=`${brightRed("Failed")} for ${brightMagenta(i+"(…)")} for ${brightYellow(t.maxAttempts.toString())} times.`),e}},n};async function e(r,i,n,s,a){try{return await r.apply(this,i)}catch(h){if(--n<0)throw console.error(h?.message),new Error("maxAttempts");if(a&&!a(h))throw h;if(s&&(await(o=s,new Promise((t=>setTimeout(t,o)))),t.backOffPolicy===BackOffPolicy.ExponentialBackOffPolicy&&t.exponentialOption)){const e=s*t.exponentialOption.multiplier;s=e>t.exponentialOption.maxInterval?t.exponentialOption.maxInterval:e}return e.apply(this,[r,i,n,s,a])}var o}}let EgoGraph=(_class1=class t{static DEFAULT_GRAPH_DEPTH=1;static DEFAULT_SEARCH_PATTERN=" vs ";static DEFAULT_GRAPH_RADIUS=10;elapsedMs=0;maxDistance=Number.NEGATIVE_INFINITY;constructor(e={query:""}){this.graph=__default1(),this.query=e.query,this.depth=e.depth??t.DEFAULT_GRAPH_DEPTH,this.pattern=e.pattern??t.DEFAULT_SEARCH_PATTERN,this.radius=e.radius??t.DEFAULT_GRAPH_RADIUS}async fetchAutocomplete(t,e){const r=t+this.pattern,i=await fetch(`http://suggestqueries.google.com/complete/search?&client=firefox&gl=us&hl=en&q=${encodeURIComponent(r)}`,fetchHeader);if(i.status===Status.OK){const t=await i.json(),r=new Set;for(const i of t[1].slice(0,e))i.split(this.pattern).slice(1).map((t=>{new RegExp("^[0-9.]+$").test(t)||r.add(t)}));return r}throw new Error(`Fetch error: ${i.status} ${i.statusText}`)}async build(){if(""===this.query)return;const t=performance.now();this.graph.beginUpdate();let e=[this.query],r=[0];for(let t=0;t<this.depth;t++){const i=[],n=[];for(let s=0;s<e.length;s++){const a=r[s];if(a>=this.radius)continue;const o=e[s],h=await this.fetchAutocomplete(o,this.radius-a);this.graph.getNode(o)||this.graph.addNode(o,{count:1,depth:o===this.query?0:t+1});let c=h.size,u=1;h.forEach((e=>{const r=a+u;r>this.maxDistance&&(this.maxDistance=r);const s=this.graph.getNode(e);if(s){s.data.count++;const t=this.graph.getLink(o,e),i=this.graph.getLink(e,o);t||i?t?t.data.weight+=c:i.data.weight+=c:this.graph.addLink(o,e,{distance:r,weight:c,query:`${o}${this.pattern}${e}`})}else this.graph.addNode(e,{count:1,depth:t+1}),this.graph.addLink(o,e,{distance:r,weight:c,query:`${o}${this.pattern}${e}`}),n.push(r),i.push(e);c-=1,u+=1}))}e=i,r=n}this.graph.endUpdate(),this.elapsedMs=performance.now()-t}toObject(){let t=Number.NEGATIVE_INFINITY;this.graph.forEachLink((e=>{e.data.weight>t&&(t=e.data.weight)}));const e={nodes:[],links:[],query:this.query,depth:this.depth,radius:this.radius,maxWeight:t,maxDistance:this.maxDistance,pattern:this.pattern,elapsedMs:this.elapsedMs};return this.graph.forEachNode((t=>{e.nodes.push({id:t.id,...t.data})})),this.graph.forEachLink((t=>{e.links.push({source:t.fromId,target:t.toId,...t.data})})),e}},_dec3=Timeout(1e3),_dec4=Retry({maxAttempts:3}),_applyDecoratedDescriptor1(_class1.prototype,"fetchAutocomplete",[_dec3,_dec4],Object.getOwnPropertyDescriptor(_class1.prototype,"fetchAutocomplete"),_class1.prototype),_dec5=Trace(),_dec6=Timeout(1e4),_applyDecoratedDescriptor1(_class1.prototype,"build",[_dec5,_dec6],Object.getOwnPropertyDescriptor(_class1.prototype,"build"),_class1.prototype),_class1);function Memoize(t={}){return function(e,r,i){const n=i.value,s=new LruCache1;let a=Number.POSITIVE_INFINITY;return i.value=async function(...e){const r=t.resolver?t.resolver.apply(this,e):JSON.stringify(e);if(s.has(r)&&(!t.ttl||a>Date.now())){const e=s.get(r);return t.onFound?.apply(this,[r,e]),e}{const i=await n.apply(this,e);return s.put(r,i),t.onAdded?.apply(this,[r,i]),t.ttl&&(a=Date.now()+t.ttl),i}},i}}function RateLimit(t){return function(e,r,i){const n=i.value,s=new __default;return i.value=async function(...e){Date.now();for(;s.peekFront()&&Date.now()-s.peekFront()>(t?.interval??1e3);)s.shift();if(s.size()>=(t?.rate??1))throw new RateLimitError1("rate limit exceeded");return s.push(Date.now()),await n.apply(this,e)},i}}let EgoNet=(_class=class{constructor(){REDIS_URL&&console.info(`${brightCyan("Redis")} is accessible at ${bold(underline(REDIS_URL))}`)}async graph(t,e){const r=new EgoGraph({query:t.query,depth:t.depth,radius:t.radius});return await r.build(),JSON.stringify(r.toObject())}async handleQuery(t,e,r){console.log(`${brightGreen(t.method)} ${bold(t.url)}`);const i=await this.graph(e,r);return t.respond({status:Status.OK,headers:r,body:i})}handleNotAcceptable(t,e){return console.error(`${t.method} ${t.url} ${brightYellow("Not acceptable")}`),t.respond({status:Status.NotAcceptable,headers:e,body:JSON.stringify({message:"Not Acceptable"})})}handleNotFound(t,e){return console.warn(`${t.method} ${t.url} ${brightYellow("Not Found")}`),t.respond({status:Status.NotFound,headers:e,body:JSON.stringify({message:"Request Not Found"})})}handleError(t,e,r){return console.error(`${t.method} ${t.url} ${brightRed(e)}`),t.respond({status:Status.InternalServerError,headers:r,body:JSON.stringify({message:"Internal server error",error:stripColor(e)})})}async startServer(){const t=serve({hostname:"0.0.0.0",port:Number(SERVER_PORT)});console.info(`${brightCyan("Server")} is running at ${bold(underline("0.0.0.0:"+SERVER_PORT))}`),console.info(`Deno: ${brightGreen(Deno.version.deno)} · V8: ${brightGreen(Deno.version.v8)} · TypeScript: ${brightGreen(Deno.version.typescript)}`);for await(const e of t){const t=e.headers.get("origin"),r=new Headers;null!==t&&-1!==ALLOWED_ORIGINS.indexOf(t)&&r.set("Access-Control-Allow-Origin",t);const i=e.headers.get("host"),n=new URLSearchParams(e.url.slice(1));i===`localhost:${SERVER_PORT}`||r.get("Access-Control-Allow-Origin")?"GET"===e.method&&n.get("q")?this.handleQuery(e,{query:n.get("q")??"",...n.get("d")&&{depth:Number(n.get("d"))},...n.get("r")&&{radius:Number(n.get("r"))}},r).catch((async t=>{await this.handleError(e,t.message,r)})):this.handleNotFound(e,r):this.handleNotAcceptable(e,r)}}},_dec=Memoize({ttl:432e5,resolver:t=>`${t.query}#${t.depth??EgoGraph.DEFAULT_GRAPH_DEPTH}#${t.pattern??EgoGraph.DEFAULT_SEARCH_PATTERN}#${t.radius??EgoGraph.DEFAULT_GRAPH_RADIUS}`,onAdded:t=>{console.log(`query="${bold(t.split("#")[0])}" added to cache`)},onFound:t=>{console.log(`query="${bold(t.split("#")[0])}" served from cache`)}}),_applyDecoratedDescriptor(_class.prototype,"graph",[_dec],Object.getOwnPropertyDescriptor(_class.prototype,"graph"),_class.prototype),_dec1=RateLimit({rate:50,interval:1e3}),_applyDecoratedDescriptor(_class.prototype,"handleQuery",[_dec1],Object.getOwnPropertyDescriptor(_class.prototype,"handleQuery"),_class.prototype),_dec2=Try(),_applyDecoratedDescriptor(_class.prototype,"handleError",[_dec2],Object.getOwnPropertyDescriptor(_class.prototype,"handleError"),_class.prototype),_class);(new EgoNet).startServer();